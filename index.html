<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1e3a8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ… | Ramadan Kareem</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* ============================
   CSS VARIABLES & RESET
   ============================ */
:root {
  --bg: #060d1f;
  --surface: #0e1b35;
  --surface2: #162444;
  --primary: #2563eb;
  --primary-light: #3b82f6;
  --primary-dark: #1d4ed8;
  --accent: #f59e0b;
  --accent2: #10b981;
  --danger: #ef4444;
  --text: #f0f4ff;
  --text-muted: #8b9cc7;
  --border: rgba(59,130,246,0.18);
  --glow: 0 0 40px rgba(37,99,235,0.3);
  --r: 18px;
  --font: 'Cairo', sans-serif;
}
[lang="en"] { --font: 'Poppins', sans-serif; }

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  position: relative;
}
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 50% -10%, rgba(37,99,235,0.18) 0%, transparent 70%),
    radial-gradient(ellipse 40% 30% at 80% 90%, rgba(16,185,129,0.07) 0%, transparent 60%);
  pointer-events: none; z-index: 0;
}

/* Stars */
.stars { position:fixed; inset:0; overflow:hidden; z-index:0; pointer-events:none; }
.star {
  position:absolute; border-radius:50%;
  background:rgba(255,255,255,0.7);
  animation: twinkle linear infinite;
}
@keyframes twinkle {
  0%,100%{opacity:.2;transform:scale(1)}
  50%{opacity:.9;transform:scale(1.4)}
}

/* ============================
   OVERLAY BASE
   ============================ */
.overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(10px);
  z-index: 500;
  display: flex; align-items: center; justify-content: center;
  padding: 16px;
  animation: fadeIn .3s ease;
}
.overlay.hidden { display: none; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes slideUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }

/* ============================
   ONBOARDING POPUP
   ============================ */
.onboard-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 0;
  width: 100%; max-width: 380px;
  max-height: 90vh;
  overflow-y: auto;
  overflow-x: hidden;
  animation: slideUp .4s ease;
  box-shadow: 0 24px 80px rgba(0,0,0,0.6), var(--glow);
}
.onboard-card::-webkit-scrollbar { display: none; }

.onboard-hero {
  background: linear-gradient(135deg, #0f2460 0%, #1d4ed8 100%);
  padding: 28px 24px 20px;
  text-align: center;
  position: relative;
}
.onboard-moon { font-size: 52px; display: block; margin-bottom: 8px; }
.onboard-hero h1 { font-size: 22px; font-weight: 900; }
.onboard-hero p { font-size: 13px; color: rgba(255,255,255,0.75); margin-top: 4px; }

/* Permission steps */
.onboard-steps { padding: 16px 20px; display: flex; flex-direction: column; gap: 10px; }
.perm-step {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
}
.perm-step-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
}
.perm-step-icon.loc { background: rgba(37,99,235,0.2); }
.perm-step-icon.notif { background: rgba(245,158,11,0.2); }
.perm-step-info h4 { font-size: 14px; font-weight: 700; }
.perm-step-info p { font-size: 12px; color: var(--text-muted); margin-top: 2px; line-height: 1.4; }
.perm-status {
  margin-right: auto; margin-left: 0;
  font-size: 18px; flex-shrink: 0;
}
[dir="ltr"] .perm-status { margin-left: auto; margin-right: 0; }

/* Install instructions */
.install-section { padding: 0 20px 8px; }
.install-tabs { display: flex; gap: 8px; margin-bottom: 12px; }
.install-tab {
  flex: 1; padding: 8px; border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text-muted);
  font-family: var(--font); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .2s;
}
.install-tab.active {
  background: var(--primary); border-color: var(--primary); color: white;
}
.install-steps-list { display: none; }
.install-steps-list.active { display: flex; flex-direction: column; gap: 8px; }
.install-step-item {
  display: flex; align-items: flex-start; gap: 10px;
  background: rgba(37,99,235,0.08);
  border: 1px solid rgba(37,99,235,0.15);
  border-radius: 12px; padding: 10px 12px;
}
.install-step-num {
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--primary); color: white;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; flex-shrink: 0;
}
.install-step-text { font-size: 13px; line-height: 1.5; }

.onboard-actions { padding: 16px 20px 24px; display: flex; flex-direction: column; gap: 8px; }
.btn-primary {
  width: 100%; padding: 14px;
  background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
  border: none; border-radius: 14px;
  color: white; font-family: var(--font); font-size: 15px; font-weight: 700;
  cursor: pointer; transition: transform .15s, box-shadow .15s;
  box-shadow: 0 4px 20px rgba(37,99,235,0.4);
}
.btn-primary:active { transform: scale(0.98); }
.btn-secondary {
  width: 100%; padding: 12px;
  background: none; border: 1px solid var(--border);
  border-radius: 14px; color: var(--text-muted);
  font-family: var(--font); font-size: 13px; cursor: pointer;
}

/* ============================
   CITY SELECTOR OVERLAY
   ============================ */
.city-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(10px);
  z-index: 600; display: flex;
  flex-direction: column;
  animation: fadeIn .2s ease;
}
.city-overlay.hidden { display: none; }

.city-header {
  padding: 16px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
}
.city-header h2 { font-size: 16px; font-weight: 700; flex: 1; }
.city-close-btn {
  width: 36px; height: 36px; border-radius: 10px;
  background: var(--surface2); border: none; color: var(--text);
  font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

.city-search-wrap {
  padding: 12px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.city-search {
  width: 100%; padding: 12px 16px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; color: var(--text);
  font-family: var(--font); font-size: 14px;
  outline: none;
}
.city-search::placeholder { color: var(--text-muted); }

.city-list { flex: 1; overflow-y: auto; padding: 8px 0; }
.city-list::-webkit-scrollbar { width: 4px; }
.city-list::-webkit-scrollbar-track { background: transparent; }
.city-list::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 2px; }

.city-group-title {
  padding: 10px 20px 4px;
  font-size: 11px; font-weight: 700;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
}
.city-item {
  padding: 12px 20px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; transition: background .15s;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.city-item:hover, .city-item:active { background: var(--surface2); }
.city-item-flag { font-size: 22px; flex-shrink: 0; }
.city-item-info h4 { font-size: 14px; font-weight: 600; }
.city-item-info p { font-size: 12px; color: var(--text-muted); }
.city-item-method {
  margin-right: auto; margin-left: 0;
  font-size: 11px; color: var(--primary-light);
  background: rgba(37,99,235,0.15);
  border-radius: 6px; padding: 2px 8px;
}
[dir="ltr"] .city-item-method { margin-left: auto; margin-right: 0; }
.city-auto-btn {
  margin: 8px 20px;
  width: calc(100% - 40px);
  padding: 12px;
  background: linear-gradient(135deg, var(--primary-dark), var(--primary));
  border: none; border-radius: 12px;
  color: white; font-family: var(--font); font-size: 14px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
}

/* ============================
   MAIN APP
   ============================ */
#app {
  position: relative; z-index: 1;
  height: 100vh; display: flex; flex-direction: column;
  max-width: 430px; margin: 0 auto;
}

/* Header */
.header {
  padding: 12px 16px 8px;
  display: flex; align-items: center; gap: 8px;
  flex-shrink: 0;
}
.header-location {
  flex: 1; display: flex; align-items: center; gap: 6px;
  font-size: 13px; color: var(--text-muted);
  cursor: pointer; min-width: 0;
}
.header-location span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-location svg { color: var(--primary-light); flex-shrink: 0; }
.header-date {
  font-size: 12px; color: var(--text-muted);
  white-space: nowrap; flex-shrink: 0;
}
.lang-btn {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text); font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: background .2s; flex-shrink: 0;
}
.lang-btn:hover { background: var(--surface2); }

/* Tab content */
.tab-content {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  scroll-behavior: smooth; padding-bottom: 80px;
}
.tab-content::-webkit-scrollbar { display: none; }

.panel { display: none; animation: fadeIn 0.25s ease; }
.panel.active { display: block; }

/* ============================
   HOME PANEL
   ============================ */
.countdown-wrap { padding: 10px 20px 0; text-align: center; }
.countdown-label { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; }

.cring { position: relative; width: 200px; height: 200px; margin: 0 auto 6px; }
.cring svg { width: 200px; height: 200px; transform: rotate(-90deg); }
.cring-bg { fill: none; stroke: var(--surface2); stroke-width: 8; }
.cring-prog {
  fill: none; stroke: url(#rg); stroke-width: 8; stroke-linecap: round;
  stroke-dasharray: 553; stroke-dashoffset: 553;
  transition: stroke-dashoffset 1s linear;
}
.cring-inner {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.ctime { font-size: 34px; font-weight: 700; letter-spacing: 2px; font-variant-numeric: tabular-nums; line-height: 1; }
.csub { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

.day-bar {
  margin: 6px 20px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 9px 14px;
  display: flex; align-items: center; gap: 10px;
}
.day-bar-track { flex: 1; height: 5px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
.day-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); border-radius: 3px; transition: width 1s linear; }
.day-bar-pct { font-size: 12px; font-weight: 700; color: var(--primary-light); min-width: 34px; text-align: left; }
[dir="rtl"] .day-bar-pct { text-align: right; }

.next-card {
  margin: 6px 20px;
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
  border-radius: var(--r); padding: 14px 18px;
  display: flex; align-items: center; justify-content: space-between;
  box-shadow: var(--glow);
}
.nc-label { font-size: 11px; color: rgba(255,255,255,0.7); }
.nc-name { font-size: 24px; font-weight: 900; }
.nc-badge {
  background: rgba(0,0,0,0.25); border-radius: 10px;
  padding: 8px 14px; text-align: center;
}
.nc-time { font-size: 20px; font-weight: 700; letter-spacing: 1px; }
.nc-remaining { font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 2px; }
.nc-alert {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25);
  border-radius: 10px; color: white; font-family: var(--font); font-size: 12px;
  padding: 5px 14px; cursor: pointer; margin-top: 8px; transition: background .2s;
}

.sec-header { padding: 10px 20px 4px; display: flex; align-items: center; justify-content: space-between; }
.sec-title { font-size: 14px; font-weight: 700; }

.prayer-list { padding: 0 20px; display: flex; flex-direction: column; gap: 5px; }
.prayer-row {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 9px 12px;
  display: flex; align-items: center; justify-content: space-between;
  transition: border-color .3s, background .3s;
}
.prayer-row.cur { border-color: var(--primary); background: rgba(37,99,235,0.1); }
.pr-left { display: flex; align-items: center; gap: 10px; }
.pr-icon {
  width: 34px; height: 34px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; background: var(--surface2);
}
.prayer-row.cur .pr-icon { background: rgba(37,99,235,0.25); }
.pr-name { font-size: 14px; font-weight: 600; }
.pr-en { font-size: 11px; color: var(--text-muted); }
.pr-right { display: flex; align-items: center; gap: 6px; }
.cur-badge {
  display: none; font-size: 10px;
  background: var(--primary); color: white;
  border-radius: 6px; padding: 2px 7px;
}
.prayer-row.cur .cur-badge { display: inline-block; }
.pr-time { font-size: 15px; font-weight: 700; letter-spacing: .5px; }
.prayer-row.cur .pr-time { color: var(--primary-light); }

.wird-card {
  margin: 10px 20px 0;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 12px 14px;
  display: flex; align-items: center; gap: 12px;
}
.wird-icon {
  width: 42px; height: 42px; background: linear-gradient(135deg, #7c3aed, #6d28d9);
  border-radius: 12px; display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}
.wird-info { flex: 1; }
.wird-title { font-size: 13px; font-weight: 700; }
.wird-sub { font-size: 12px; color: var(--text-muted); }
.wird-go {
  width: 34px; height: 34px; background: var(--primary);
  border-radius: 10px; border: none; color: white; cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-size: 12px;
}

.quote-card {
  margin: 10px 20px;
  background: var(--surface); border: 1px solid var(--border);
  border-inline-start: 3px solid var(--accent);
  border-radius: var(--r); padding: 12px 14px;
}
.qt { font-size: 14px; line-height: 1.8; }
.qs { font-size: 11px; color: var(--text-muted); margin-top: 6px; }

/* ============================
   NOTIFICATIONS PANEL
   ============================ */
.notif-hero {
  margin: 12px 20px;
  background: linear-gradient(135deg, var(--primary-dark), var(--primary));
  border-radius: var(--r); padding: 16px 18px;
  display: flex; align-items: center; gap: 12px;
  box-shadow: var(--glow);
}
.nh-icon { font-size: 36px; }
.nh-title { font-size: 17px; font-weight: 900; }
.nh-sub { font-size: 12px; color: rgba(255,255,255,0.75); }

.notif-section { padding: 6px 20px; }
.ns-title {
  font-size: 12px; font-weight: 700; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
}
.ns-badge {
  font-size: 10px; background: var(--primary); color: white;
  border-radius: 6px; padding: 2px 7px; text-transform: none; letter-spacing: 0;
}

.notif-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); overflow: hidden; margin-bottom: 8px;
}
.notif-row {
  padding: 12px 14px; display: flex; align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.notif-row:last-child { border-bottom: none; }
.nr-left { display: flex; align-items: center; gap: 10px; }
.nr-icon {
  width: 40px; height: 40px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center; font-size: 18px;
}
.nr-title { font-size: 13px; font-weight: 600; }
.nr-sub { font-size: 11px; color: var(--text-muted); }

.time-picker-wrap { padding: 0 14px 10px; display: none; }
.time-picker-wrap.show { display: block; }
.tpw-inner {
  background: var(--surface2); border-radius: 10px;
  padding: 8px 12px; display: flex; align-items: center; justify-content: space-between;
}
.tpw-inner input[type="time"] {
  background: none; border: none; color: var(--text);
  font-family: var(--font); font-size: 18px; font-weight: 700;
  outline: none; cursor: pointer; direction: ltr;
}
.tpw-inner input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1) opacity(.5); }
.tpw-label { font-size: 12px; color: var(--text-muted); }

/* Toggle */
.toggle { position: relative; width: 46px; height: 25px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.tslider {
  position: absolute; inset: 0;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 13px; cursor: pointer; transition: .3s;
}
.tslider::before {
  content: ''; position: absolute;
  width: 19px; height: 19px; left: 2px; top: 2px;
  background: var(--text-muted); border-radius: 50%; transition: .3s;
}
.toggle input:checked + .tslider { background: var(--primary); border-color: var(--primary); }
.toggle input:checked + .tslider::before { transform: translateX(21px); background: white; }

/* ============================
   QURAN PANEL
   ============================ */
.khatm-top { padding: 14px 20px 6px; text-align: center; }
.kring { position: relative; width: 170px; height: 170px; margin: 0 auto 10px; }
.kring svg { width: 170px; height: 170px; transform: rotate(-90deg); }
.kring-inner {
  position: absolute; inset: 0;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.kpct { font-size: 36px; font-weight: 900; }
.kpct span { font-size: 18px; }
.ksub { font-size: 11px; color: var(--text-muted); }
.klevel {
  display: inline-block; background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white; border-radius: 20px; padding: 3px 14px;
  font-size: 11px; font-weight: 700; margin-top: 3px;
}

.kstats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 20px 8px; }
.kstat {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; padding: 10px 14px; text-align: center;
}
.kstat-val { font-size: 20px; font-weight: 900; color: var(--primary-light); }
.kstat-val span { font-size: 12px; font-weight: 600; }
.kstat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

.khatm-sel { padding: 6px 20px; }
.ks-title { font-size: 13px; font-weight: 700; margin-bottom: 8px; }
.ks-tabs { display: flex; gap: 7px; overflow-x: auto; }
.ks-tabs::-webkit-scrollbar { display: none; }
.ks-tab {
  flex-shrink: 0; padding: 6px 16px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; font-family: var(--font);
  font-size: 13px; font-weight: 600; color: var(--text-muted);
  cursor: pointer; transition: all .2s; white-space: nowrap;
}
.ks-tab.active { background: var(--primary); border-color: var(--primary); color: white; }

.today-plan { padding: 6px 20px; }
.tp-title { font-size: 13px; font-weight: 700; margin-bottom: 8px; }
.plan-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); overflow: hidden;
}
.plan-item {
  padding: 11px 14px; display: flex; align-items: center;
  justify-content: space-between; border-bottom: 1px solid var(--border);
}
.plan-item:last-child { border-bottom: none; }
.pi-range { font-size: 14px; font-weight: 600; }
.pi-surah { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
.pi-right { display: flex; align-items: center; gap: 8px; }
.pi-done { width: 26px; height: 26px; border-radius: 50%; background: var(--accent2); display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; }
.pi-btn {
  background: var(--primary); border: none; border-radius: 8px;
  color: white; font-family: var(--font); font-size: 12px; font-weight: 600;
  padding: 6px 14px; cursor: pointer; transition: background .2s; white-space: nowrap;
}
.pi-btn.done { background: var(--surface2); color: var(--text-muted); }

.achievements { padding: 6px 20px 12px; }
.ach-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
.ach-grid { display: flex; gap: 10px; overflow-x: auto; }
.ach-grid::-webkit-scrollbar { display: none; }
.ach-item { flex-shrink: 0; width: 72px; text-align: center; }
.ach-icon {
  width: 56px; height: 56px; border-radius: 50%;
  margin: 0 auto 5px; display: flex; align-items: center; justify-content: center;
  font-size: 24px; background: var(--surface2); border: 2px solid var(--border);
}
.ach-item.earned .ach-icon {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  border-color: #f59e0b; box-shadow: 0 4px 16px rgba(245,158,11,.4);
}
.ach-name { font-size: 10px; color: var(--text-muted); }
.ach-item.earned .ach-name { color: var(--accent); }

/* ============================
   QURAN MODAL
   ============================ */
.qmodal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.95);
  z-index: 700; display: none; flex-direction: column;
}
.qmodal.show { display: flex; animation: fadeIn .25s; }
.qm-header {
  padding: 14px 16px; background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.qm-title { font-size: 15px; font-weight: 700; }
.qm-close {
  width: 34px; height: 34px; background: var(--surface2);
  border: none; border-radius: 10px; color: var(--text);
  font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.qm-body { flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 10px 8px; gap: 6px; background: #1a1a2e; }
.qm-body::-webkit-scrollbar { display: none; }
.qm-img-wrap {
  width: 100%; max-width: 390px;
  background: #fff;
  border-radius: 4px;
  padding: 6px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.5);
  line-height: 0;
  position: relative;
}
.qm-img { width: 100%; display: block; border-radius: 2px; }

/* Tap zone hints - shown briefly when page opens */
.tap-hint {
  position: absolute; top: 0; bottom: 0; width: 33%;
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; pointer-events: none;
  opacity: 0; transition: opacity .3s;
  border-radius: 4px;
}
.tap-hint.left  { left: 0;  background: linear-gradient(to right,  rgba(37,99,235,0.18), transparent); }
.tap-hint.right { right: 0; background: linear-gradient(to left,   rgba(37,99,235,0.18), transparent); }
.tap-hint.show  { opacity: 1; }
.qm-footer { padding: 10px 16px; background: var(--surface); display: flex; gap: 8px; flex-shrink: 0; }
.qm-btn {
  flex: 1; background: var(--primary); border: none; border-radius: 12px;
  color: white; font-family: var(--font); font-size: 13px; font-weight: 700;
  padding: 11px; cursor: pointer; transition: background .2s;
}
.qm-btn:hover { background: var(--primary-light); }
.qm-btn.sec { background: var(--surface2); color: var(--text); }
.qm-btn.ok { background: var(--accent2); }
.qm-btn:disabled { opacity: .4; cursor: default; }

/* ============================
   SETTINGS
   ============================ */
.settings-body { padding: 16px 20px; }
.settings-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 16px; margin-bottom: 12px;
}
.sc-title { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
.sc-info { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; line-height: 1.5; }
.sc-btn {
  background: var(--primary); border: none; border-radius: 10px;
  color: white; font-family: var(--font); font-size: 13px; font-weight: 600;
  padding: 9px 20px; cursor: pointer; transition: background .2s;
}
.sc-btn:hover { background: var(--primary-light); }
.sc-btn.danger { background: rgba(239,68,68,0.2); color: #f87171; }

/* ============================
   CONTACT MODAL
   ============================ */
.contact-modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: flex; align-items: flex-end; justify-content: center;
  z-index: 9999; opacity: 0; pointer-events: none;
  transition: opacity .3s;
}
.contact-modal-overlay.active { opacity: 1; pointer-events: all; }
.contact-modal {
  background: var(--surface); border-radius: 20px 20px 0 0;
  width: 100%; max-width: 430px; padding: 28px 20px 36px;
  transform: translateY(100%); transition: transform .35s cubic-bezier(.4,0,.2,1);
}
.contact-modal-overlay.active .contact-modal { transform: translateY(0); }
.contact-modal h3 { font-size: 17px; font-weight: 800; margin-bottom: 6px; }
.contact-modal p { font-size: 12px; color: var(--text-muted); margin-bottom: 18px; line-height: 1.5; }
.cg { margin-bottom: 14px; }
.cg label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
.cg input, .cg textarea {
  width: 100%; background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: 10px; padding: 12px 14px; color: var(--text);
  font-family: var(--font); font-size: 13px; outline: none;
  transition: border-color .2s;
}
.cg input:focus, .cg textarea:focus { border-color: var(--primary); }
.cg textarea { min-height: 90px; resize: vertical; }
.contact-send-btn {
  width: 100%; padding: 14px; background: #25D366;
  border: none; border-radius: 12px; color: white;
  font-family: var(--font); font-size: 14px; font-weight: 700;
  cursor: pointer; margin-top: 4px; transition: opacity .2s;
}
.contact-send-btn:disabled { opacity: .5; cursor: not-allowed; }
.contact-close-btn {
  position: absolute; top: 16px; left: 16px;
  background: var(--surface2); border: none; border-radius: 50%;
  width: 32px; height: 32px; color: var(--text-muted);
  font-size: 18px; cursor: pointer; display: flex;
  align-items: center; justify-content: center;
}
.contact-modal { position: relative; }
.contact-status { margin-top: 12px; padding: 10px 14px; border-radius: 10px;
  font-size: 13px; display: none; text-align: center; }
.contact-status.ok { background: rgba(37,211,102,.15); color: #25D366; }
.contact-status.err { background: rgba(239,68,68,.15); color: #f87171; }

/* ============================
   BOTTOM NAV
   ============================ */
.bottom-nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 430px;
  background: rgba(14,27,53,0.97); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex; z-index: 50;
  padding: 6px 0 env(safe-area-inset-bottom);
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 5px 0; cursor: pointer; color: var(--text-muted);
  font-size: 10px; font-weight: 600; transition: color .2s;
  border: none; background: none; font-family: var(--font);
}
.nav-btn.active { color: var(--primary-light); }
.nav-icon { font-size: 20px; line-height: 1; }
.nav-btn.active .nav-icon { filter: drop-shadow(0 0 5px var(--primary-light)); }

/* ============================
   TOAST & LOADING
   ============================ */
.toast {
  position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; padding: 10px 20px;
  font-size: 13px; font-weight: 600; z-index: 800;
  display: none; white-space: nowrap; backdrop-filter: blur(20px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.toast.show { display: block; animation: slideUp .3s ease; }

.loading-screen {
  position: fixed; inset: 0; background: var(--bg);
  z-index: 900; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 14px;
  transition: opacity .5s;
}
.loading-screen.gone { opacity: 0; pointer-events: none; }
.loading-moon { font-size: 56px; animation: pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.15)} }
.loading-txt { font-size: 15px; color: var(--text-muted); }
.loading-dots::after {
  content: ''; animation: dots 1.5s steps(4,end) infinite;
}
@keyframes dots { 0%{content:''} 25%{content:'.'} 50%{content:'..'} 75%{content:'...'} 100%{content:''} }

/* ============================
   AZAN ALARM BANNER
   ============================ */
.azan-banner {
  position: fixed; top: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 430px;
  background: linear-gradient(135deg, #0f2460 0%, #1d4ed8 50%, #0f2460 100%);
  background-size: 200% 100%;
  animation: azanPulse 2s ease-in-out infinite;
  z-index: 950;
  padding: 14px 16px;
  display: none; flex-direction: column; align-items: center; gap: 10px;
  box-shadow: 0 4px 30px rgba(37,99,235,0.6);
}
.azan-banner.show { display: flex; }
@keyframes azanPulse {
  0%,100% { background-position: 0% 50%; box-shadow: 0 4px 30px rgba(37,99,235,0.6); }
  50% { background-position: 100% 50%; box-shadow: 0 4px 50px rgba(37,99,235,0.9); }
}
.azan-top { display: flex; align-items: center; gap: 12px; width: 100%; }
.azan-waves { display: flex; gap: 3px; align-items: flex-end; height: 28px; }
.azan-wave {
  width: 4px; background: rgba(255,255,255,0.9); border-radius: 2px;
  animation: wave 0.8s ease-in-out infinite;
}
.azan-wave:nth-child(1) { height: 10px; animation-delay: 0s; }
.azan-wave:nth-child(2) { height: 20px; animation-delay: 0.1s; }
.azan-wave:nth-child(3) { height: 28px; animation-delay: 0.2s; }
.azan-wave:nth-child(4) { height: 20px; animation-delay: 0.3s; }
.azan-wave:nth-child(5) { height: 10px; animation-delay: 0.4s; }
@keyframes wave {
  0%,100% { transform: scaleY(0.5); opacity: 0.6; }
  50% { transform: scaleY(1); opacity: 1; }
}
.azan-info { flex: 1; }
.azan-title { font-size: 15px; font-weight: 900; }
.azan-sub { font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 2px; }
.azan-stop {
  background: white; color: #1d4ed8;
  border: none; border-radius: 12px;
  padding: 9px 20px; font-family: var(--font);
  font-size: 14px; font-weight: 900;
  cursor: pointer; white-space: nowrap;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  transition: transform .15s;
}
.azan-stop:active { transform: scale(0.95); }

/* Install prompt (Android) */
.install-bar {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  width: calc(100% - 28px); max-width: 400px;
  background: linear-gradient(135deg, var(--primary-dark), var(--primary));
  border-radius: var(--r); padding: 11px 14px;
  display: none; align-items: center; gap: 10px;
  z-index: 60; box-shadow: 0 8px 32px rgba(37,99,235,.4);
  animation: slideUp .4s ease;
}
.install-bar.show { display: flex; }
.ib-text { flex: 1; }
.ib-text strong { font-size: 13px; display: block; }
.ib-text span { font-size: 11px; color: rgba(255,255,255,.75); }
.ib-install {
  background: white; color: var(--primary-dark); border: none;
  border-radius: 10px; padding: 7px 14px;
  font-family: var(--font); font-size: 13px; font-weight: 700;
  cursor: pointer; white-space: nowrap;
}
.ib-close {
  background: none; border: none;
  color: rgba(255,255,255,.7); font-size: 18px; cursor: pointer; padding: 4px;
}
</style>
</head>
<body>

<!-- ==================== STARS ==================== -->
<div class="stars" id="stars"></div>

<!-- ==================== LOADING ==================== -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-moon">ğŸŒ™</div>
  <div class="loading-txt" id="loadingTxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„<span class="loading-dots"></span></div>
  <div style="font-size:11px;color:var(--text-muted);text-align:center;padding:0 40px">
    <span id="loadingNote">ÙŠØªÙ… Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø±Ø³Ù…ÙŠØ©</span>
  </div>
</div>

<!-- ==================== TOAST ==================== -->
<div class="toast" id="toast"></div>

<!-- ==================== AZAN BANNER ==================== -->
<div class="azan-banner" id="azanBanner">
  <div class="azan-top">
    <div class="azan-waves">
      <div class="azan-wave"></div>
      <div class="azan-wave"></div>
      <div class="azan-wave"></div>
      <div class="azan-wave"></div>
      <div class="azan-wave"></div>
    </div>
    <div class="azan-info">
      <div class="azan-title" id="azanTitle">ğŸ•Œ Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©</div>
      <div class="azan-sub" id="azanSub">Ø§Ù„Ø£Ø°Ø§Ù† ÙŠÙØ´ØºÙÙ‘Ù„ Ø§Ù„Ø¢Ù†</div>
    </div>
    <button class="azan-stop" onclick="stopAzan()" id="azanStopBtn">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
  </div>
</div>

<!-- ==================== ONBOARDING ==================== -->
<div class="overlay" id="onboardOverlay">
  <div class="onboard-card">

    <!-- 1ï¸âƒ£ Install Instructions FIRST -->
    <div class="install-section" id="installInstructions" style="padding:20px 20px 8px">
      <div style="text-align:center;margin-bottom:12px">
        <span style="font-size:32px">ğŸ“²</span>
        <div style="font-size:15px;font-weight:900;margin-top:4px" id="ob-install-heading">ÙƒÙŠÙÙŠØ© ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:2px" id="ob-install-sub">Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø°Ø§Ù† ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
      </div>
      <div class="install-tabs">
        <button class="install-tab active" onclick="switchInstallTab('android')" id="tab-android">
          ğŸ¤– Android
        </button>
        <button class="install-tab" onclick="switchInstallTab('ios')" id="tab-ios">
          ğŸ iPhone / iPad
        </button>
      </div>
      <div class="install-steps-list active" id="steps-android"></div>
      <div class="install-steps-list" id="steps-ios"></div>
    </div>

    <!-- Divider -->
    <div style="height:1px;background:var(--border);margin:4px 0"></div>

    <!-- 2ï¸âƒ£ App Hero -->
    <div class="onboard-hero">
      <span class="onboard-moon">ğŸŒ™</span>
      <h1 id="ob-title">Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…</h1>
      <p id="ob-sub">Ø¥Ù…Ø³Ø§ÙƒÙŠØ© Â· Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Â· Ø®ØªÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†</p>
    </div>

    <!-- 3ï¸âƒ£ Permissions -->
    <div class="onboard-steps">
      <div class="perm-step">
        <div class="perm-step-icon loc">ğŸ“</div>
        <div class="perm-step-info">
          <h4 id="ob-loc-title">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</h4>
          <p id="ob-loc-desc">Ù„Ø¹Ø±Ø¶ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù…Ø¯ÙŠÙ†ØªÙƒ</p>
        </div>
        <div class="perm-status" id="locStatus">â¬œ</div>
      </div>
      <div class="perm-step">
        <div class="perm-step-icon notif">ğŸ””</div>
        <div class="perm-step-info">
          <h4 id="ob-notif-title">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h4>
          <p id="ob-notif-desc">Ù„ØªÙ„Ù‚ÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø³Ø­ÙˆØ± ÙˆØ§Ù„Ø¥ÙØ·Ø§Ø±</p>
        </div>
        <div class="perm-status" id="notifStatus">â¬œ</div>
      </div>
    </div>

    <!-- 4ï¸âƒ£ Actions -->
    <div class="onboard-actions">
      <button class="btn-primary" id="obStartBtn" onclick="startApp()">
        <span id="ob-start-txt">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</span>
      </button>
      <button class="btn-secondary" id="obSkipBtn" onclick="skipOnboard()">
        <span id="ob-skip-txt">ØªØ®Ø·Ù‰</span>
      </button>
    </div>
  </div>
</div>

<!-- ==================== CITY SELECTOR ==================== -->
<div class="city-overlay hidden" id="cityOverlay">
  <div class="city-header">
    <button class="city-close-btn" onclick="closeCitySelector()">âœ•</button>
    <h2 id="city-title">Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†ØªÙƒ</h2>
  </div>
  <div class="city-search-wrap">
    <button class="city-auto-btn" id="autoLocBtn" onclick="tryAutoLocation()">
      ğŸ“ <span id="autoLocTxt">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>
    </button>
  </div>
  <div class="city-search-wrap" style="border-top:1px solid var(--border);padding-top:8px">
    <input class="city-search" id="citySearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†ØªÙƒ..." oninput="filterCities(this.value)">
  </div>
  <div class="city-list" id="cityList"></div>
</div>

<!-- ==================== QURAN MODAL ==================== -->
<div class="qmodal" id="qmodal">
  <div class="qm-header">
    <button class="qm-close" id="qmClose">âœ•</button>
    <div class="qm-title" id="qmTitle">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙŠÙˆÙ…</div>
    <div style="width:34px"></div>
  </div>
  <div class="qm-body" id="qmBody"></div>
  <div class="qm-footer">
    <button class="qm-btn sec" id="qmPrev">â—€</button>
    <button class="qm-btn ok" id="qmDone" onclick="markDone()">âœ“ <span id="qm-done-txt">Ø¥ØªÙ…Ø§Ù…</span></button>
    <button class="qm-btn" id="qmNext">â–¶</button>
  </div>
</div>

<!-- ==================== INSTALL BAR ==================== -->
<div class="install-bar" id="installBar">
  <span style="font-size:22px">ğŸ“²</span>
  <div class="ib-text">
    <strong id="ib-title">Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</strong>
    <span id="ib-sub">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©</span>
  </div>
  <button class="ib-install" id="ib-install-btn">
    <span id="ib-btn-txt">ØªØ«Ø¨ÙŠØª</span>
  </button>
  <button class="ib-close" onclick="document.getElementById('installBar').classList.remove('show')">Ã—</button>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="app">
  <div class="header">
    <div class="header-location" onclick="openCitySelector()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
      <span id="locDisplay">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>
    </div>
    <div class="header-date" id="hijriDisplay"></div>
    <button class="lang-btn" onclick="toggleLang()" title="English / Ø¹Ø±Ø¨ÙŠ">ğŸŒ</button>
  </div>

  <div class="tab-content">

    <!-- HOME -->
    <div class="panel active" id="panel-home">
      <div class="countdown-wrap">
        <div class="countdown-label" id="ctLabel">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¥ÙØ·Ø§Ø±</div>
        <div class="cring">
          <svg viewBox="0 0 200 200">
            <defs>
              <linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#1d4ed8"/>
                <stop offset="100%" stop-color="#60a5fa"/>
              </linearGradient>
            </defs>
            <circle class="cring-bg" cx="100" cy="100" r="88"/>
            <circle class="cring-prog" id="ringProg" cx="100" cy="100" r="88"/>
          </svg>
          <div class="cring-inner">
            <div class="ctime" id="ctTime">--:--:--</div>
            <div class="csub" id="ctSub">Ø­ØªÙ‰ Ø§Ù„Ù…ØºØ±Ø¨</div>
          </div>
        </div>
      </div>

      <div class="day-bar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <div class="day-bar-track"><div class="day-bar-fill" id="dayFill"></div></div>
        <div class="day-bar-pct" id="dayPct">0%</div>
        <span style="font-size:11px;color:var(--text-muted)" id="dayLbl">Ù…Ù† Ø§Ù„ÙŠÙˆÙ…</span>
      </div>

      <div class="next-card">
        <div>
          <div class="nc-label" id="nc-label">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
          <div class="nc-name" id="nc-name">--</div>
          <button class="nc-alert" onclick="goNotif()" id="nc-alert-btn">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØµÙ„Ø§Ø©</button>
        </div>
        <div>
          <div class="nc-badge">
            <div class="nc-time" id="nc-time">--:--</div>
            <div class="nc-remaining" id="nc-rem">Ù…ØªØ¨Ù‚ÙŠ --:--</div>
          </div>
        </div>
      </div>

      <div class="sec-header">
        <div class="sec-title" id="home-imsakiya-title">ğŸ•Œ Ø¥Ù…Ø³Ø§ÙƒÙŠØ© Ø§Ù„ÙŠÙˆÙ…</div>
      </div>
      <div class="prayer-list" id="prayerList"></div>

      <div class="wird-card">
        <div class="wird-icon">ğŸ“–</div>
        <div class="wird-info">
          <div class="wird-title" id="wird-title">ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="wird-sub" id="wird-sub">-</div>
        </div>
        <button class="wird-go" onclick="switchTab('quran')">â–¶</button>
      </div>

      <div class="quote-card">
        <div class="qt" id="qt"></div>
        <div class="qs" id="qs"></div>
      </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div class="panel" id="panel-notif">
      <div class="notif-hero">
        <div class="nh-icon">ğŸ””</div>
        <div>
          <div class="nh-title" id="nh-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
          <div class="nh-sub" id="nh-sub">-</div>
        </div>
      </div>
      <div class="notif-section">
        <div class="ns-title" id="ns1-title">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© <span class="ns-badge">Prayer Times</span></div>
        <div class="notif-card" id="prayerNotifCard"></div>
      </div>
      <div class="notif-section">
        <div class="ns-title" id="ns2-title">Ù…Ù†Ø¨Ù‡Ø§Øª Ø±Ù…Ø¶Ø§Ù† <span class="ns-badge">Ramadan Special</span></div>
        <div class="notif-card">
          <!-- SUHOOR -->
          <div class="notif-row">
            <div class="nr-left">
              <div class="nr-icon" style="background:rgba(245,158,11,.15)">ğŸŒ™</div>
              <div>
                <div class="nr-title" id="suhoor-label">Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø³Ø­ÙˆØ±</div>
                <div class="nr-sub">Wake up for Suhoor</div>
              </div>
            </div>
            <label class="toggle"><input type="checkbox" id="tog-suhoor" onchange="saveAlarm('suhoor')"><span class="tslider"></span></label>
          </div>
          <div class="time-picker-wrap" id="tp-suhoor">
            <div class="tpw-inner">
              <span class="tpw-label" id="suhoor-time-lbl">Ø§Ù„ÙˆÙ‚Øª</span>
              <input type="time" id="time-suhoor" value="03:30" onchange="saveAlarm('suhoor')">
            </div>
          </div>
          <!-- QIYAM -->
          <div class="notif-row">
            <div class="nr-left">
              <div class="nr-icon" style="background:rgba(99,102,241,.15)">âœ¨</div>
              <div>
                <div class="nr-title" id="qiyam-label">ØµÙ„Ø§Ø© Ø§Ù„Ù‚ÙŠØ§Ù…</div>
                <div class="nr-sub">Qiyam Night Prayer</div>
              </div>
            </div>
            <label class="toggle"><input type="checkbox" id="tog-qiyam" onchange="saveAlarm('qiyam')"><span class="tslider"></span></label>
          </div>
          <div class="time-picker-wrap" id="tp-qiyam">
            <div class="tpw-inner">
              <span class="tpw-label" id="qiyam-time-lbl">Ø§Ù„ÙˆÙ‚Øª</span>
              <input type="time" id="time-qiyam" value="02:00" onchange="saveAlarm('qiyam')">
            </div>
          </div>
          <!-- IFTAR -->
          <div class="notif-row">
            <div class="nr-left">
              <div class="nr-icon" style="background:rgba(239,68,68,.15)">ğŸ½ï¸</div>
              <div>
                <div class="nr-title" id="iftar-label">ØªØ°ÙƒÙŠØ± Ø§Ù„Ø¥ÙØ·Ø§Ø±</div>
                <div class="nr-sub">Iftar Reminder</div>
              </div>
            </div>
            <label class="toggle"><input type="checkbox" id="tog-iftar" onchange="saveAlarm('iftar')"><span class="tslider"></span></label>
          </div>
          <!-- DHIKR -->
          <div class="notif-row" style="border-bottom:none">
            <div class="nr-left">
              <div class="nr-icon" style="background:rgba(16,185,129,.15)">ğŸ¤²</div>
              <div>
                <div class="nr-title" id="dhikr-label">Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
                <div class="nr-sub">Daily Dhikr</div>
              </div>
            </div>
            <label class="toggle"><input type="checkbox" id="tog-dhikr" onchange="saveAlarm('dhikr')"><span class="tslider"></span></label>
          </div>
        </div>
      </div>
    </div>

    <!-- QURAN -->
    <div class="panel" id="panel-quran">
      <div class="khatm-top">
        <div class="kring">
          <svg viewBox="0 0 170 170">
            <defs>
              <linearGradient id="kg" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#1d4ed8"/>
                <stop offset="100%" stop-color="#10b981"/>
              </linearGradient>
            </defs>
            <circle fill="none" stroke="var(--surface2)" stroke-width="10" cx="85" cy="85" r="74"/>
            <circle fill="none" stroke="url(#kg)" stroke-width="10" cx="85" cy="85" r="74"
              stroke-linecap="round" stroke-dasharray="465" stroke-dashoffset="465" id="kringProg"
              style="transition:stroke-dashoffset 1s ease"/>
          </svg>
          <div class="kring-inner">
            <div class="kpct"><span id="kPct">Ù </span>Ùª</div>
            <div class="ksub" id="kSub">ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ù  ØµÙØ­Ø©</div>
            <div class="klevel" id="kLevel">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¡: Ù…Ø¨ØªØ¯Ø¦</div>
          </div>
        </div>
      </div>

      <div class="kstats">
        <div class="kstat">
          <div class="kstat-val" id="kDaily">Ù <span id="kDaily-unit"> ØµÙØ­Ø©</span></div>
          <div class="kstat-label" id="kDailyLbl">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
        </div>
        <div class="kstat">
          <div class="kstat-val" id="kDays">Ù£Ù <span id="kDays-unit"> ÙŠÙˆÙ…</span></div>
          <div class="kstat-label" id="kDaysLbl">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
        </div>
      </div>

      <div class="khatm-sel">
        <div class="ks-title" id="khatm-count-title">ğŸ“š Ø¹Ø¯Ø¯ Ø§Ù„Ø®ØªÙ…Ø§Øª</div>
        <div class="ks-tabs">
          <button class="ks-tab active" onclick="setKhatmat(1)" id="ktab-1">Ù¡ Ø®ØªÙ…Ø©</button>
          <button class="ks-tab" onclick="setKhatmat(2)" id="ktab-2">Ù¢ Ø®ØªÙ…Ø©</button>
          <button class="ks-tab" onclick="setKhatmat(3)" id="ktab-3">Ù£ Ø®ØªÙ…Ø§Øª</button>
        </div>
      </div>

      <div class="today-plan">
        <div class="tp-title" id="today-plan-title">ğŸ“… Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„ÙŠÙˆÙ… Ù¡)</div>
        <div class="plan-card" id="planCard"></div>
      </div>

      <div class="achievements">
        <div class="ach-title" id="ach-title">ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div>
        <div class="ach-grid" id="achGrid"></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="panel" id="panel-settings">
      <div class="settings-body">
        <h2 style="font-size:17px;font-weight:900;margin-bottom:14px" id="settings-heading">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

        <div class="settings-card">
          <div class="sc-title" id="sc-loc-title">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
          <div class="sc-info" id="sc-loc-info">-</div>
          <button class="sc-btn" onclick="openCitySelector()" id="sc-loc-btn">ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</button>
        </div>

        <div class="settings-card">
          <div class="sc-title" id="sc-method-title">ğŸ•Œ Ø·Ø±ÙŠÙ‚Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</div>
          <div class="sc-info" id="sc-method-desc">ØªØ­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯ÙŠÙ†ØªÙƒ. ØªØºÙŠÙŠØ± ÙŠØ¯ÙˆÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.</div>
          <select id="methodSelect" onchange="onMethodChange()" style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:var(--font);font-size:13px;outline:none">
            <option value="16">Dubai / Ø¯Ø¨ÙŠ</option>
            <option value="4" selected>Umm Al-Qura / Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰</option>
            <option value="8">Gulf / Ø§Ù„Ø®Ù„ÙŠØ¬</option>
            <option value="3">Egypt / Ù…ØµØ±</option>
            <option value="12">Diyanet / ØªØ±ÙƒÙŠØ§</option>
            <option value="2">ISNA / Ø£Ù…Ø±ÙŠÙƒØ§</option>
            <option value="5">Karachi / ÙƒØ±Ø§ØªØ´ÙŠ</option>
            <option value="1">University of Islamic Sciences, Karachi</option>
            <option value="11">MWL</option>
            <option value="15">Tehran</option>
            <option value="99">Custom</option>
          </select>
        </div>

        <div class="settings-card">
          <div class="sc-title" id="sc-perm-title">ğŸ”” ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</div>
          <div class="sc-info" id="sc-perm-info">Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©</div>
          <button class="sc-btn" onclick="askNotifPermission()" id="sc-perm-btn">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
        </div>

        <div class="settings-card">
          <div class="sc-title" id="sc-contact-title">ğŸ’¬ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±</div>
          <div class="sc-info" id="sc-contact-info">Ø§Ù‚ØªØ±Ø§Ø­ØŒ Ù…Ø´ÙƒÙ„Ø©ØŒ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø© â€” Ø±Ø³Ø§Ù„ØªÙƒ ØªØµÙ„Ù†ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</div>
          <button class="sc-btn" onclick="openContactModal()" id="sc-contact-btn">Ø±Ø§Ø³Ù„Ù†Ø§</button>
        </div>

        <div class="settings-card">
          <div class="sc-info" id="sc-data-info">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙ‚Ø¯Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†</div>
          <button class="sc-btn danger" onclick="confirmResetQuran()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div style="text-align:center;font-size:11px;color:var(--text-muted);margin-top:16px">
          Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ… v2.0 ğŸŒ™<br>
          <span style="font-size:10px">Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ù…Ù† <a href="https://aladhan.com" style="color:var(--primary-light);text-decoration:none">Aladhan API</a></span>
        </div>
      </div>
    </div>

  </div><!-- end tab-content -->

  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('home')" id="nav-home">
      <span class="nav-icon">ğŸ </span><span id="nav-home-txt">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </button>
    <button class="nav-btn" onclick="switchTab('notif')" id="nav-notif">
      <span class="nav-icon">ğŸ””</span><span id="nav-notif-txt">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
    </button>
    <button class="nav-btn" onclick="switchTab('quran')" id="nav-quran">
      <span class="nav-icon">ğŸ“–</span><span id="nav-quran-txt">Ø§Ù„Ù‚Ø±Ø¢Ù†</span>
    </button>
    <button class="nav-btn" onclick="switchTab('settings')" id="nav-settings">
      <span class="nav-icon">âš™ï¸</span><span id="nav-settings-txt">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
    </button>
  </nav>
</div><!-- end app -->

<script>
// =============================================================
// CITIES DATABASE
// =============================================================
const CITIES = [
  // UAE
  { name:'Ø£Ø¨ÙˆØ¸Ø¨ÙŠ', nameEn:'Abu Dhabi', country:'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', countryEn:'UAE', flag:'ğŸ‡¦ğŸ‡ª', lat:24.4539, lng:54.3773, method:16 },
  { name:'Ø¯Ø¨ÙŠ', nameEn:'Dubai', country:'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', countryEn:'UAE', flag:'ğŸ‡¦ğŸ‡ª', lat:25.2048, lng:55.2708, method:16 },
  { name:'Ø§Ù„Ø´Ø§Ø±Ù‚Ø©', nameEn:'Sharjah', country:'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', countryEn:'UAE', flag:'ğŸ‡¦ğŸ‡ª', lat:25.3462, lng:55.4209, method:16 },
  { name:'Ø¹Ø¬Ù…Ø§Ù†', nameEn:'Ajman', country:'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', countryEn:'UAE', flag:'ğŸ‡¦ğŸ‡ª', lat:25.4111, lng:55.4354, method:16 },
  { name:'Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©', nameEn:'Ras Al Khaimah', country:'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', countryEn:'UAE', flag:'ğŸ‡¦ğŸ‡ª', lat:25.7895, lng:55.9432, method:16 },
  { name:'Ø§Ù„ÙØ¬ÙŠØ±Ø©', nameEn:'Fujairah', country:'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', countryEn:'UAE', flag:'ğŸ‡¦ğŸ‡ª', lat:25.1288, lng:56.3265, method:16 },
  { name:'Ø§Ù„Ø¹ÙŠÙ†', nameEn:'Al Ain', country:'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª', countryEn:'UAE', flag:'ğŸ‡¦ğŸ‡ª', lat:24.2075, lng:55.7447, method:16 },
  // Saudi Arabia
  { name:'Ø§Ù„Ø±ÙŠØ§Ø¶', nameEn:'Riyadh', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:24.7136, lng:46.6753, method:4 },
  { name:'Ø¬Ø¯Ø©', nameEn:'Jeddah', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:21.4858, lng:39.1925, method:4 },
  { name:'Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©', nameEn:'Mecca', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:21.3891, lng:39.8579, method:4 },
  { name:'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©', nameEn:'Medina', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:24.4672, lng:39.6150, method:4 },
  { name:'Ø§Ù„Ø¯Ù…Ø§Ù…', nameEn:'Dammam', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:26.4207, lng:50.0888, method:4 },
  { name:'Ø§Ù„Ø®Ø¨Ø±', nameEn:'Khobar', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:26.2172, lng:50.1971, method:4 },
  { name:'Ø§Ù„Ø¸Ù‡Ø±Ø§Ù†', nameEn:'Dhahran', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:26.2671, lng:50.1478, method:4 },
  { name:'Ø§Ù„Ø£Ø­Ø³Ø§Ø¡', nameEn:'Al-Ahsa', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:25.3810, lng:49.5860, method:4 },
  { name:'ØªØ¨ÙˆÙƒ', nameEn:'Tabuk', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:28.3835, lng:36.5662, method:4 },
  { name:'Ø£Ø¨Ù‡Ø§', nameEn:'Abha', country:'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', countryEn:'Saudi Arabia', flag:'ğŸ‡¸ğŸ‡¦', lat:18.2164, lng:42.5053, method:4 },
  // Kuwait
  { name:'Ø§Ù„ÙƒÙˆÙŠØª', nameEn:'Kuwait City', country:'Ø§Ù„ÙƒÙˆÙŠØª', countryEn:'Kuwait', flag:'ğŸ‡°ğŸ‡¼', lat:29.3759, lng:47.9774, method:8 },
  { name:'Ø­ÙˆÙ„ÙŠ', nameEn:'Hawalli', country:'Ø§Ù„ÙƒÙˆÙŠØª', countryEn:'Kuwait', flag:'ğŸ‡°ğŸ‡¼', lat:29.3365, lng:48.0291, method:8 },
  // Bahrain
  { name:'Ø§Ù„Ù…Ù†Ø§Ù…Ø©', nameEn:'Manama', country:'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†', countryEn:'Bahrain', flag:'ğŸ‡§ğŸ‡­', lat:26.2235, lng:50.5876, method:8 },
  { name:'Ø§Ù„Ù…Ø­Ø±Ù‚', nameEn:'Muharraq', country:'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†', countryEn:'Bahrain', flag:'ğŸ‡§ğŸ‡­', lat:26.2619, lng:50.6116, method:8 },
  // Qatar
  { name:'Ø§Ù„Ø¯ÙˆØ­Ø©', nameEn:'Doha', country:'Ù‚Ø·Ø±', countryEn:'Qatar', flag:'ğŸ‡¶ğŸ‡¦', lat:25.2854, lng:51.5310, method:8 },
  // Oman
  { name:'Ù…Ø³Ù‚Ø·', nameEn:'Muscat', country:'Ø¹ÙÙ…Ø§Ù†', countryEn:'Oman', flag:'ğŸ‡´ğŸ‡²', lat:23.5880, lng:58.3829, method:8 },
  { name:'ØµÙ„Ø§Ù„Ø©', nameEn:'Salalah', country:'Ø¹ÙÙ…Ø§Ù†', countryEn:'Oman', flag:'ğŸ‡´ğŸ‡²', lat:17.0151, lng:54.0924, method:8 },
  // Jordan
  { name:'Ø¹Ù…Ù‘Ø§Ù†', nameEn:'Amman', country:'Ø§Ù„Ø£Ø±Ø¯Ù†', countryEn:'Jordan', flag:'ğŸ‡¯ğŸ‡´', lat:31.9539, lng:35.9106, method:3 },
  { name:'Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡', nameEn:'Zarqa', country:'Ø§Ù„Ø£Ø±Ø¯Ù†', countryEn:'Jordan', flag:'ğŸ‡¯ğŸ‡´', lat:32.0728, lng:36.0878, method:3 },
  // Palestine
  { name:'Ø±Ø§Ù… Ø§Ù„Ù„Ù‡', nameEn:'Ramallah', country:'ÙÙ„Ø³Ø·ÙŠÙ†', countryEn:'Palestine', flag:'ğŸ‡µğŸ‡¸', lat:31.9038, lng:35.2034, method:3 },
  { name:'ØºØ²Ø©', nameEn:'Gaza', country:'ÙÙ„Ø³Ø·ÙŠÙ†', countryEn:'Palestine', flag:'ğŸ‡µğŸ‡¸', lat:31.5017, lng:34.4668, method:3 },
  { name:'Ø§Ù„Ù‚Ø¯Ø³', nameEn:'Jerusalem', country:'ÙÙ„Ø³Ø·ÙŠÙ†', countryEn:'Palestine', flag:'ğŸ‡µğŸ‡¸', lat:31.7683, lng:35.2137, method:3 },
  { name:'Ø§Ù„Ø®Ù„ÙŠÙ„', nameEn:'Hebron', country:'ÙÙ„Ø³Ø·ÙŠÙ†', countryEn:'Palestine', flag:'ğŸ‡µğŸ‡¸', lat:31.5350, lng:35.0998, method:3 },
  { name:'Ù†Ø§Ø¨Ù„Ø³', nameEn:'Nablus', country:'ÙÙ„Ø³Ø·ÙŠÙ†', countryEn:'Palestine', flag:'ğŸ‡µğŸ‡¸', lat:32.2211, lng:35.2544, method:3 },
  // Egypt
  { name:'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©', nameEn:'Cairo', country:'Ù…ØµØ±', countryEn:'Egypt', flag:'ğŸ‡ªğŸ‡¬', lat:30.0444, lng:31.2357, method:3 },
  { name:'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©', nameEn:'Alexandria', country:'Ù…ØµØ±', countryEn:'Egypt', flag:'ğŸ‡ªğŸ‡¬', lat:31.2001, lng:29.9187, method:3 },
  { name:'Ø§Ù„Ø¬ÙŠØ²Ø©', nameEn:'Giza', country:'Ù…ØµØ±', countryEn:'Egypt', flag:'ğŸ‡ªğŸ‡¬', lat:30.0131, lng:31.2089, method:3 },
  { name:'Ø£Ø³ÙŠÙˆØ·', nameEn:'Asyut', country:'Ù…ØµØ±', countryEn:'Egypt', flag:'ğŸ‡ªğŸ‡¬', lat:27.1877, lng:31.1837, method:3 },
  // Lebanon
  { name:'Ø¨ÙŠØ±ÙˆØª', nameEn:'Beirut', country:'Ù„Ø¨Ù†Ø§Ù†', countryEn:'Lebanon', flag:'ğŸ‡±ğŸ‡§', lat:33.8938, lng:35.5018, method:3 },
  // Syria
  { name:'Ø¯Ù…Ø´Ù‚', nameEn:'Damascus', country:'Ø³ÙˆØ±ÙŠØ§', countryEn:'Syria', flag:'ğŸ‡¸ğŸ‡¾', lat:33.5138, lng:36.2765, method:3 },
  { name:'Ø­Ù„Ø¨', nameEn:'Aleppo', country:'Ø³ÙˆØ±ÙŠØ§', countryEn:'Syria', flag:'ğŸ‡¸ğŸ‡¾', lat:36.2021, lng:37.1343, method:3 },
  // Iraq
  { name:'Ø¨ØºØ¯Ø§Ø¯', nameEn:'Baghdad', country:'Ø§Ù„Ø¹Ø±Ø§Ù‚', countryEn:'Iraq', flag:'ğŸ‡®ğŸ‡¶', lat:33.3152, lng:44.3661, method:3 },
  { name:'Ø§Ù„Ø¨ØµØ±Ø©', nameEn:'Basra', country:'Ø§Ù„Ø¹Ø±Ø§Ù‚', countryEn:'Iraq', flag:'ğŸ‡®ğŸ‡¶', lat:30.5085, lng:47.7804, method:3 },
  { name:'Ø§Ù„Ù…ÙˆØµÙ„', nameEn:'Mosul', country:'Ø§Ù„Ø¹Ø±Ø§Ù‚', countryEn:'Iraq', flag:'ğŸ‡®ğŸ‡¶', lat:36.3350, lng:43.1189, method:3 },
  { name:'Ø£Ø±Ø¨ÙŠÙ„', nameEn:'Erbil', country:'Ø§Ù„Ø¹Ø±Ø§Ù‚', countryEn:'Iraq', flag:'ğŸ‡®ğŸ‡¶', lat:36.1912, lng:44.0092, method:3 },
  // Morocco
  { name:'Ø§Ù„Ø±Ø¨Ø§Ø·', nameEn:'Rabat', country:'Ø§Ù„Ù…ØºØ±Ø¨', countryEn:'Morocco', flag:'ğŸ‡²ğŸ‡¦', lat:34.0209, lng:-6.8416, method:3 },
  { name:'Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡', nameEn:'Casablanca', country:'Ø§Ù„Ù…ØºØ±Ø¨', countryEn:'Morocco', flag:'ğŸ‡²ğŸ‡¦', lat:33.5731, lng:-7.5898, method:3 },
  { name:'Ù…Ø±Ø§ÙƒØ´', nameEn:'Marrakech', country:'Ø§Ù„Ù…ØºØ±Ø¨', countryEn:'Morocco', flag:'ğŸ‡²ğŸ‡¦', lat:31.6295, lng:-7.9811, method:3 },
  { name:'ÙØ§Ø³', nameEn:'Fez', country:'Ø§Ù„Ù…ØºØ±Ø¨', countryEn:'Morocco', flag:'ğŸ‡²ğŸ‡¦', lat:34.0181, lng:-5.0078, method:3 },
  // Algeria
  { name:'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', nameEn:'Algiers', country:'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', countryEn:'Algeria', flag:'ğŸ‡©ğŸ‡¿', lat:36.7538, lng:3.0588, method:3 },
  { name:'ÙˆÙ‡Ø±Ø§Ù†', nameEn:'Oran', country:'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', countryEn:'Algeria', flag:'ğŸ‡©ğŸ‡¿', lat:35.6969, lng:-0.6331, method:3 },
  // Tunisia
  { name:'ØªÙˆÙ†Ø³', nameEn:'Tunis', country:'ØªÙˆÙ†Ø³', countryEn:'Tunisia', flag:'ğŸ‡¹ğŸ‡³', lat:36.8188, lng:10.1658, method:3 },
  // Libya
  { name:'Ø·Ø±Ø§Ø¨Ù„Ø³', nameEn:'Tripoli', country:'Ù„ÙŠØ¨ÙŠØ§', countryEn:'Libya', flag:'ğŸ‡±ğŸ‡¾', lat:32.9025, lng:13.1806, method:3 },
  // Sudan
  { name:'Ø§Ù„Ø®Ø±Ø·ÙˆÙ…', nameEn:'Khartoum', country:'Ø§Ù„Ø³ÙˆØ¯Ø§Ù†', countryEn:'Sudan', flag:'ğŸ‡¸ğŸ‡©', lat:15.5007, lng:32.5599, method:3 },
  // Yemen
  { name:'ØµÙ†Ø¹Ø§Ø¡', nameEn:'Sanaa', country:'Ø§Ù„ÙŠÙ…Ù†', countryEn:'Yemen', flag:'ğŸ‡¾ğŸ‡ª', lat:15.3694, lng:44.1910, method:4 },
  { name:'Ø¹Ø¯Ù†', nameEn:'Aden', country:'Ø§Ù„ÙŠÙ…Ù†', countryEn:'Yemen', flag:'ğŸ‡¾ğŸ‡ª', lat:12.7855, lng:45.0187, method:4 },
  // Turkey
  { name:'Ø¥Ø³Ø·Ù†Ø¨ÙˆÙ„', nameEn:'Istanbul', country:'ØªØ±ÙƒÙŠØ§', countryEn:'Turkey', flag:'ğŸ‡¹ğŸ‡·', lat:41.0082, lng:28.9784, method:12 },
  { name:'Ø£Ù†Ù‚Ø±Ø©', nameEn:'Ankara', country:'ØªØ±ÙƒÙŠØ§', countryEn:'Turkey', flag:'ğŸ‡¹ğŸ‡·', lat:39.9334, lng:32.8597, method:12 },
  { name:'Ø¥Ø²Ù…ÙŠØ±', nameEn:'Izmir', country:'ØªØ±ÙƒÙŠØ§', countryEn:'Turkey', flag:'ğŸ‡¹ğŸ‡·', lat:38.4192, lng:27.1287, method:12 },
  // Pakistan
  { name:'ÙƒØ±Ø§ØªØ´ÙŠ', nameEn:'Karachi', country:'Ø¨Ø§ÙƒØ³ØªØ§Ù†', countryEn:'Pakistan', flag:'ğŸ‡µğŸ‡°', lat:24.8607, lng:67.0011, method:5 },
  { name:'Ù„Ø§Ù‡ÙˆØ±', nameEn:'Lahore', country:'Ø¨Ø§ÙƒØ³ØªØ§Ù†', countryEn:'Pakistan', flag:'ğŸ‡µğŸ‡°', lat:31.5204, lng:74.3587, method:5 },
  { name:'Ø¥Ø³Ù„Ø§Ù… Ø¢Ø¨Ø§Ø¯', nameEn:'Islamabad', country:'Ø¨Ø§ÙƒØ³ØªØ§Ù†', countryEn:'Pakistan', flag:'ğŸ‡µğŸ‡°', lat:33.7294, lng:73.0931, method:5 },
  // India
  { name:'Ù†ÙŠÙˆØ¯Ù„Ù‡ÙŠ', nameEn:'New Delhi', country:'Ø§Ù„Ù‡Ù†Ø¯', countryEn:'India', flag:'ğŸ‡®ğŸ‡³', lat:28.6139, lng:77.2090, method:1 },
  { name:'Ù…ÙˆÙ…Ø¨Ø§ÙŠ', nameEn:'Mumbai', country:'Ø§Ù„Ù‡Ù†Ø¯', countryEn:'India', flag:'ğŸ‡®ğŸ‡³', lat:19.0760, lng:72.8777, method:1 },
  { name:'Ø­ÙŠØ¯Ø± Ø¢Ø¨Ø§Ø¯', nameEn:'Hyderabad', country:'Ø§Ù„Ù‡Ù†Ø¯', countryEn:'India', flag:'ğŸ‡®ğŸ‡³', lat:17.3850, lng:78.4867, method:1 },
  // Malaysia
  { name:'ÙƒÙˆØ§Ù„Ø§Ù„Ù…Ø¨ÙˆØ±', nameEn:'Kuala Lumpur', country:'Ù…Ø§Ù„ÙŠØ²ÙŠØ§', countryEn:'Malaysia', flag:'ğŸ‡²ğŸ‡¾', lat:3.1390, lng:101.6869, method:3 },
  // Indonesia
  { name:'Ø¬Ø§ÙƒØ±ØªØ§', nameEn:'Jakarta', country:'Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§', countryEn:'Indonesia', flag:'ğŸ‡®ğŸ‡©', lat:-6.2088, lng:106.8456, method:20 },
  // UK
  { name:'Ù„Ù†Ø¯Ù†', nameEn:'London', country:'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©', countryEn:'UK', flag:'ğŸ‡¬ğŸ‡§', lat:51.5074, lng:-0.1278, method:2 },
  { name:'Ù…Ø§Ù†Ø´Ø³ØªØ±', nameEn:'Manchester', country:'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©', countryEn:'UK', flag:'ğŸ‡¬ğŸ‡§', lat:53.4808, lng:-2.2426, method:2 },
  // France
  { name:'Ø¨Ø§Ø±ÙŠØ³', nameEn:'Paris', country:'ÙØ±Ù†Ø³Ø§', countryEn:'France', flag:'ğŸ‡«ğŸ‡·', lat:48.8566, lng:2.3522, method:11 },
  // Germany
  { name:'Ø¨Ø±Ù„ÙŠÙ†', nameEn:'Berlin', country:'Ø£Ù„Ù…Ø§Ù†ÙŠØ§', countryEn:'Germany', flag:'ğŸ‡©ğŸ‡ª', lat:52.5200, lng:13.4050, method:11 },
  // Netherlands
  { name:'Ø£Ù…Ø³ØªØ±Ø¯Ø§Ù…', nameEn:'Amsterdam', country:'Ù‡ÙˆÙ„Ù†Ø¯Ø§', countryEn:'Netherlands', flag:'ğŸ‡³ğŸ‡±', lat:52.3676, lng:4.9041, method:11 },
  // USA
  { name:'Ù†ÙŠÙˆÙŠÙˆØ±Ùƒ', nameEn:'New York', country:'Ø£Ù…Ø±ÙŠÙƒØ§', countryEn:'USA', flag:'ğŸ‡ºğŸ‡¸', lat:40.7128, lng:-74.0060, method:2 },
  { name:'Ù„ÙˆØ³ Ø£Ù†Ø¬Ù„ÙˆØ³', nameEn:'Los Angeles', country:'Ø£Ù…Ø±ÙŠÙƒØ§', countryEn:'USA', flag:'ğŸ‡ºğŸ‡¸', lat:34.0522, lng:-118.2437, method:2 },
  { name:'Ø´ÙŠÙƒØ§ØºÙˆ', nameEn:'Chicago', country:'Ø£Ù…Ø±ÙŠÙƒØ§', countryEn:'USA', flag:'ğŸ‡ºğŸ‡¸', lat:41.8781, lng:-87.6298, method:2 },
  { name:'Ù‡ÙŠÙˆØ³ØªÙ†', nameEn:'Houston', country:'Ø£Ù…Ø±ÙŠÙƒØ§', countryEn:'USA', flag:'ğŸ‡ºğŸ‡¸', lat:29.7604, lng:-95.3698, method:2 },
  // Canada
  { name:'ØªÙˆØ±Ù†ØªÙˆ', nameEn:'Toronto', country:'ÙƒÙ†Ø¯Ø§', countryEn:'Canada', flag:'ğŸ‡¨ğŸ‡¦', lat:43.6510, lng:-79.3470, method:2 },
  { name:'Ù…ÙˆÙ†ØªØ±ÙŠØ§Ù„', nameEn:'Montreal', country:'ÙƒÙ†Ø¯Ø§', countryEn:'Canada', flag:'ğŸ‡¨ğŸ‡¦', lat:45.5017, lng:-73.5673, method:2 },
  // Australia
  { name:'Ø³ÙŠØ¯Ù†ÙŠ', nameEn:'Sydney', country:'Ø£Ø³ØªØ±Ø§Ù„ÙŠØ§', countryEn:'Australia', flag:'ğŸ‡¦ğŸ‡º', lat:-33.8688, lng:151.2093, method:3 },
  { name:'Ù…Ù„Ø¨ÙˆØ±Ù†', nameEn:'Melbourne', country:'Ø£Ø³ØªØ±Ø§Ù„ÙŠØ§', countryEn:'Australia', flag:'ğŸ‡¦ğŸ‡º', lat:-37.8136, lng:144.9631, method:3 },
  // Iran
  { name:'Ø·Ù‡Ø±Ø§Ù†', nameEn:'Tehran', country:'Ø¥ÙŠØ±Ø§Ù†', countryEn:'Iran', flag:'ğŸ‡®ğŸ‡·', lat:35.6892, lng:51.3890, method:7 },
  // South Africa
  { name:'Ø¬ÙˆÙ‡Ø§Ù†Ø³Ø¨Ø±Øº', nameEn:'Johannesburg', country:'Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§', countryEn:'South Africa', flag:'ğŸ‡¿ğŸ‡¦', lat:-26.2041, lng:28.0473, method:3 },
  // Nigeria
  { name:'Ù„Ø§ØºÙˆØ³', nameEn:'Lagos', country:'Ù†ÙŠØ¬ÙŠØ±ÙŠØ§', countryEn:'Nigeria', flag:'ğŸ‡³ğŸ‡¬', lat:6.5244, lng:3.3792, method:3 },
  // Senegal
  { name:'Ø¯Ø§ÙƒØ§Ø±', nameEn:'Dakar', country:'Ø§Ù„Ø³Ù†ØºØ§Ù„', countryEn:'Senegal', flag:'ğŸ‡¸ğŸ‡³', lat:14.7167, lng:-17.4677, method:3 },
];

// =============================================================
// TRANSLATIONS
// =============================================================
const T = {
  ar: {
    loading: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„',
    loadingNote: 'ÙŠØªÙ… Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø±Ø³Ù…ÙŠØ©',
    obTitle: 'Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…',
    obSub: 'Ø¥Ù…Ø³Ø§ÙƒÙŠØ© Â· Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Â· Ø®ØªÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†',
    obLocTitle: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ',
    obLocDesc: 'Ù„Ø¹Ø±Ø¶ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù…Ø¯ÙŠÙ†ØªÙƒ',
    obNotifTitle: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
    obNotifDesc: 'Ù„ØªÙ„Ù‚ÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø³Ø­ÙˆØ± ÙˆØ§Ù„Ø¥ÙØ·Ø§Ø±',
    obStart: 'ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†',
    obSkip: 'ØªØ®Ø·Ù‰',
    androidSteps: [
      'Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ù…ØªØµÙØ­ Chrome',
      'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« â‹® ÙÙŠ Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø©',
      'Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"',
      'Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©" ÙˆØ³ÙŠØ¸Ù‡Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'
    ],
    iosSteps: [
      'Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ù…ØªØµÙØ­ Safari',
      'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ğŸ“¤ ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©',
      'Ø§Ø®ØªØ± "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" â•',
      'Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©" ÙÙŠ Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø©'
    ],
    cityTitle: 'Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†ØªÙƒ',
    autoLoc: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹',
    citySearch: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†ØªÙƒ...',
    ctLabel: 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¥ÙØ·Ø§Ø±',
    ctLabelSuhoor: 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø³Ø­ÙˆØ±',
    ctSub: 'Ø­ØªÙ‰ Ø§Ù„Ù…ØºØ±Ø¨',
    ctSubSuhoor: 'Ø­ØªÙ‰ Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ',
    dayLbl: 'Ù…Ù† Ø§Ù„ÙŠÙˆÙ…',
    ncLabel: 'Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©',
    ncAlertBtn: 'ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØµÙ„Ø§Ø©',
    ncRem: 'Ù…ØªØ¨Ù‚ÙŠ',
    imsakiyaTitle: 'ğŸ•Œ Ø¥Ù…Ø³Ø§ÙƒÙŠØ© Ø§Ù„ÙŠÙˆÙ…',
    wirdTitle: 'ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…',
    prayerNames: { Fajr:'Ø§Ù„ÙØ¬Ø±', Sunrise:'Ø§Ù„Ø´Ø±ÙˆÙ‚', Dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', Asr:'Ø§Ù„Ø¹ØµØ±', Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨ (Ø¥ÙØ·Ø§Ø±)', Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡' },
    prayerNamesShort: { Fajr:'Ø§Ù„ÙØ¬Ø±', Sunrise:'Ø§Ù„Ø´Ø±ÙˆÙ‚', Dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', Asr:'Ø§Ù„Ø¹ØµØ±', Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨', Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡' },
    ampm: { am:'Øµ', pm:'Ù…' },
    nhTitle: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª',
    ns1: 'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©',
    ns2: 'Ù…Ù†Ø¨Ù‡Ø§Øª Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø®Ø§ØµØ©',
    suhoor: 'Ù…Ù†Ø¨Ù‡ Ø§Ù„Ø³Ø­ÙˆØ±', qiyam: 'ØµÙ„Ø§Ø© Ø§Ù„Ù‚ÙŠØ§Ù…',
    iftar: 'ØªØ°ÙƒÙŠØ± Ø§Ù„Ø¥ÙØ·Ø§Ø±', dhikr: 'Ø§Ù„Ø£Ø°ÙƒØ§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
    timeLabel: 'Ø§Ù„ÙˆÙ‚Øª',
    khatmCount: 'ğŸ“š Ø¹Ø¯Ø¯ Ø§Ù„Ø®ØªÙ…Ø§Øª',
    khatmTabs: ['Ù¡ Ø®ØªÙ…Ø©','Ù¢ Ø®ØªÙ…ØªÙŠÙ†','Ù£ Ø®ØªÙ…Ø§Øª'],
    todayPlan: 'ğŸ“… Ø®Ø·Ø© Ø§Ù„ÙŠÙˆÙ…',
    dayWord: 'Ø§Ù„ÙŠÙˆÙ…',
    pagesFrom: 'Ù…Ù† ØµÙØ­Ø©',
    pagesTo: 'Ø¥Ù„Ù‰',
    surahLabel: 'Ø³ÙˆØ±Ø©',
    khatmLabel: 'Ø§Ù„Ø®ØªÙ…Ø©',
    readBtn: 'Ø§Ù‚Ø±Ø£',
    doneBtn: 'Ù…ÙƒØªÙ…Ù„',
    achTitle: 'ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª',
    achievements: [
      {icon:'ğŸŒŸ', name:'Ø¨Ø¯Ø§ÙŠØ© Ù‚ÙˆÙŠØ©', t:1},
      {icon:'ğŸ“¿', name:'Ù…Ø«Ø§Ø¨Ø± Ø±Ù…Ø¶Ø§Ù†', t:33},
      {icon:'ğŸ…', name:'Ù†ØµÙ Ø§Ù„Ø®ØªÙ…Ø©', t:50},
      {icon:'ğŸ’', name:'Ø§Ù„Ø¹Ø´Ø± Ø§Ù„Ø£ÙˆØ§Ø®Ø±', t:66},
      {icon:'ğŸ†', name:'Ø®ØªÙ…Ø© ÙƒØ§Ù…Ù„Ø©', t:100}
    ],
    levels: [[0,'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¡: Ù…Ø¨ØªØ¯Ø¦ ğŸ“–'],[25,'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¢: Ù…ØªØ¹Ù„Ù… ğŸ“š'],[50,'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù£: Ù‚Ø§Ø±Ø¦ Ù…Ù†ØªØ¸Ù… â­'],[75,'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¤: Ù‚Ø§Ø±Ø¦ Ù…ØªÙ…ÙŠØ² ğŸŒŸ'],[90,'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù¥: Ø­Ø§ÙØ¸ ğŸ†']],
    completed: 'ØªÙ… Ø¥ÙƒÙ…Ø§Ù„',
    page: 'ØµÙØ­Ø©',
    daily: 'Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ',
    daysLeft: 'Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©',
    day: 'ÙŠÙˆÙ…',
    khatmDone: 'Ù…Ø§Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© ğŸŒŸ',
    qmDone: 'Ø¥ØªÙ…Ø§Ù…',
    settingsH: 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
    scLoc: 'ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹',
    scLocBtn: 'ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©',
    scMethod: 'ğŸ•Œ Ø·Ø±ÙŠÙ‚Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª',
    scMethodDesc: 'ØªØ­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯ÙŠÙ†ØªÙƒ',
    scPerm: 'ğŸ”” ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±',
    scPermInfo: 'Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©',
    scPermBtn: 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
    scData: 'ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
    scDataInfo: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙ‚Ø¯Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†',
    navHome:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', navNotif:'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', navQuran:'Ø§Ù„Ù‚Ø±Ø¢Ù†', navSettings:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
    ibTitle: 'Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', ibSub: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©', ibBtn: 'ØªØ«Ø¨ÙŠØª',
    toastNotifOn: 'ØªÙ†Ø¨ÙŠÙ‡ Ù…ÙØ¹Ù‘Ù„ âœ…', toastNotifOff: 'ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¹Ø·Ù‘Ù„',
    toastLocOk: 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ',
    toastLocFail: 'âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†ØªÙƒ ÙŠØ¯ÙˆÙŠØ§Ù‹',
    toastNotifGranted: 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
    toastNotifDenied: 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­',
    confirmReset: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªÙ‚Ø¯Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ',
    toastReset: 'ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†',
  },
  en: {
    loading: 'Loading',
    loadingNote: 'Fetching official prayer times for your location',
    obTitle: 'Ramadan Kareem',
    obSub: 'Imsakiyah Â· Prayer Times Â· Quran Khatm',
    obLocTitle: 'Location',
    obLocDesc: 'For accurate prayer times in your city',
    obNotifTitle: 'Notifications',
    obNotifDesc: 'For prayer, suhoor and iftar alerts',
    obStart: 'ğŸš€ Get Started',
    obSkip: 'Skip',
    androidSteps: [
      'Open in Chrome browser',
      'Tap the three-dot menu â‹® in the top right',
      'Select "Add to Home screen"',
      'Tap "Add" â€” the app icon will appear'
    ],
    iosSteps: [
      'Open in Safari browser',
      'Tap the Share button ğŸ“¤ at the bottom',
      'Choose "Add to Home Screen" â•',
      'Tap "Add" in the top right corner'
    ],
    cityTitle: 'Choose your city',
    autoLoc: 'Detect location automatically',
    citySearch: 'Search for your city...',
    ctLabel: 'Time remaining for Iftar',
    ctLabelSuhoor: 'Time remaining for Suhoor',
    ctSub: 'Until Maghrib',
    ctSubSuhoor: 'Until Imsak',
    dayLbl: 'of today',
    ncLabel: 'Next Prayer',
    ncAlertBtn: 'ğŸ”” Prayer Alert',
    ncRem: 'in',
    imsakiyaTitle: 'ğŸ•Œ Today\'s Imsakiyah',
    wirdTitle: "Today's Reading",
    prayerNames: { Fajr:'Fajr', Sunrise:'Sunrise', Dhuhr:'Dhuhr', Asr:'Asr', Maghrib:'Maghrib (Iftar)', Isha:'Isha' },
    prayerNamesShort: { Fajr:'Fajr', Sunrise:'Sunrise', Dhuhr:'Dhuhr', Asr:'Asr', Maghrib:'Maghrib', Isha:'Isha' },
    ampm: { am:'AM', pm:'PM' },
    nhTitle: 'Manage Notifications',
    ns1: 'Prayer Notifications',
    ns2: 'Ramadan Special Alarms',
    suhoor:'Suhoor Alarm', qiyam:'Qiyam Prayer',
    iftar:'Iftar Reminder', dhikr:'Daily Dhikr',
    timeLabel: 'Time',
    khatmCount: 'ğŸ“š Number of Khatms',
    khatmTabs: ['1 Khatm','2 Khatms','3 Khatms'],
    todayPlan: 'ğŸ“… Today\'s Plan',
    dayWord: 'Day',
    pagesFrom: 'Pages',
    pagesTo: 'to',
    surahLabel: 'Surah',
    khatmLabel: 'Khatm',
    readBtn: 'Read',
    doneBtn: 'Done',
    achTitle: 'ğŸ† Achievements',
    achievements: [
      {icon:'ğŸŒŸ', name:'Strong Start', t:1},
      {icon:'ğŸ“¿', name:'Consistent', t:33},
      {icon:'ğŸ…', name:'Halfway', t:50},
      {icon:'ğŸ’', name:'Last 10 days', t:66},
      {icon:'ğŸ†', name:'Full Khatm', t:100}
    ],
    levels: [[0,'Level 1: Beginner ğŸ“–'],[25,'Level 2: Learner ğŸ“š'],[50,'Level 3: Regular â­'],[75,'Level 4: Distinguished ğŸŒŸ'],[90,'Level 5: Hafiz ğŸ†']],
    completed: 'Completed',
    page: 'pages',
    daily: 'Daily Average',
    daysLeft: 'Days Left',
    day: 'days',
    khatmDone: 'MashaAllah! Session recorded ğŸŒŸ',
    qmDone: 'Done',
    settingsH: 'âš™ï¸ Settings',
    scLoc: 'ğŸ“ Location',
    scLocBtn: 'Change City',
    scMethod: 'ğŸ•Œ Calculation Method',
    scMethodDesc: 'Set automatically based on your city',
    scPerm: 'ğŸ”” Notification Permission',
    scPermInfo: 'Required for prayer alerts',
    scPermBtn: 'Enable Notifications',
    scData: 'ğŸ“Š App Data',
    scDataInfo: 'Reset Quran progress',
    navHome:'Home', navNotif:'Alerts', navQuran:'Quran', navSettings:'Settings',
    ibTitle:'Install App', ibSub:'Get prayer notifications', ibBtn:'Install',
    toastNotifOn:'Alert enabled âœ…', toastNotifOff:'Alert disabled',
    toastLocOk:'âœ… Location set',
    toastLocFail:'âš ï¸ Auto-detect failed. Choose your city manually',
    toastNotifGranted:'âœ… Notifications enabled',
    toastNotifDenied:'âš ï¸ Please allow from browser settings',
    confirmReset: 'Reset Quran progress?',
    toastReset: 'ğŸ”„ Progress reset',
  }
};

const QUOTES = [
  { ar: 'Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠ Ø£ÙÙ†Ø²ÙÙ„Ù ÙÙÙŠÙ‡Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù Ù‡ÙØ¯Ù‹Ù‰ Ù„ÙÙ‘Ù„Ù†ÙÙ‘Ø§Ø³Ù', en: '"The month of Ramadan in which was revealed the Quran, a guidance for the people"', src: 'Al-Baqarah 2:185' },
  { ar: 'Ù…ÙÙ†Ù’ ØµÙØ§Ù…Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù Ø¥ÙÙŠÙ…ÙØ§Ù†Ù‹Ø§ ÙˆÙØ§Ø­Ù’ØªÙØ³ÙØ§Ø¨Ù‹Ø§ ØºÙÙÙØ±Ù Ù„ÙÙ‡Ù Ù…ÙØ§ ØªÙÙ‚ÙØ¯ÙÙ‘Ù…Ù Ù…ÙÙ†Ù’ Ø°ÙÙ†Ù’Ø¨ÙÙ‡Ù', en: '"Whoever fasts in Ramadan with faith and seeking reward, his past sins are forgiven"', src: 'Hadith Sharif' },
  { ar: 'Ø§Ù‚Ù’Ø±ÙØ¡ÙÙˆØ§ Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù ÙÙØ¥ÙÙ†ÙÙ‘Ù‡Ù ÙŠÙØ£Ù’ØªÙÙŠ ÙŠÙÙˆÙ’Ù…Ù Ø§Ù„Ù’Ù‚ÙÙŠÙØ§Ù…ÙØ©Ù Ø´ÙÙÙÙŠØ¹Ù‹Ø§ Ù„ÙØ£ÙØµÙ’Ø­ÙØ§Ø¨ÙÙ‡Ù', en: '"Read the Quran, for it will come as an intercessor for its companions on the Day of Resurrection"', src: 'Hadith Sharif' },
];

const PRAYER_ICONS = { Fajr:'ğŸŒ„', Sunrise:'â˜€ï¸', Dhuhr:'ğŸŒ¤ï¸', Asr:'ğŸŒ‡', Maghrib:'ğŸŒ†', Isha:'ğŸŒ™' };
const QURAN_PAGES = 604;
const RAMADAN_DAYS = 30;

// =============================================================
// STATE
// =============================================================
let S = {
  lang: 'ar',
  lat: null, lng: null,
  cityName: '', cityNameEn: '',
  prayers: {}, timestamps: {},
  hijri: '',
  ramadanDay: 1,
  method: 4,
  nextPrayer: null,
  khatmat: 1,
  completedSessions: {},
  notifSettings: {},
  initialized: false
};

function t(key) { return T[S.lang][key] || T['ar'][key] || key; }

// =============================================================
// PERSIST
// =============================================================
function loadPersist() {
  try {
    const d = JSON.parse(localStorage.getItem('ramadan_v2') || '{}');
    if (d.lang) S.lang = d.lang;
    if (d.khatmat) S.khatmat = d.khatmat;
    if (d.completedSessions) S.completedSessions = d.completedSessions;
    if (d.notifSettings) S.notifSettings = d.notifSettings;
    if (d.lat) { S.lat = d.lat; S.lng = d.lng; }
    if (d.cityName) S.cityName = d.cityName;
    if (d.cityNameEn) S.cityNameEn = d.cityNameEn;
    if (d.method) S.method = d.method;
    if (d.initialized) S.initialized = d.initialized;
  } catch(e) {}
}
function savePersist() {
  try {
    localStorage.setItem('ramadan_v2', JSON.stringify({
      lang: S.lang, khatmat: S.khatmat,
      completedSessions: S.completedSessions,
      notifSettings: S.notifSettings,
      lat: S.lat, lng: S.lng,
      cityName: S.cityName, cityNameEn: S.cityNameEn,
      method: S.method, initialized: S.initialized
    }));
  } catch(e) {}
}

// =============================================================
// UTILS
// =============================================================
function toAr(n) { return String(n).replace(/[0-9]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[+d]); }
function numStr(n) { return S.lang === 'ar' ? toAr(n) : String(n); }

function fmt12(t24) {
  if (!t24) return '--:--';
  const clean = t24.split(' ')[0];
  const [h,m] = clean.split(':').map(Number);
  const isAm = h < 12;
  const h12 = h % 12 || 12;
  const ampm = S.lang === 'ar' ? (isAm ? 'Øµ' : 'Ù…') : (isAm ? 'AM' : 'PM');
  return `${String(h12).padStart(2,'0')}:${String(m).padStart(2,'0')} ${ampm}`;
}

function toMs(t24) {
  const [h,m] = t24.split(' ')[0].split(':').map(Number);
  const d = new Date();
  return new Date(d.getFullYear(),d.getMonth(),d.getDate(),h,m,0).getTime();
}

function showToast(msg, ms = 2800) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), ms);
}

function isStandalone() {
  return window.matchMedia('(display-mode: standalone)').matches ||
         window.navigator.standalone ||
         document.referrer.includes('android-app://');
}

function createStars() {
  const c = document.getElementById('stars');
  for (let i = 0; i < 55; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const sz = Math.random() * 2.5 + 0.5;
    s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-duration:${Math.random()*4+2}s;animation-delay:${Math.random()*5}s`;
    c.appendChild(s);
  }
}

// =============================================================
// LANGUAGE
// =============================================================
function applyLang() {
  const isAr = S.lang === 'ar';
  document.documentElement.lang = S.lang;
  document.documentElement.dir = isAr ? 'rtl' : 'ltr';

  // Onboarding
  setText('ob-title', t('obTitle'));
  setText('ob-sub', t('obSub'));
  setText('ob-loc-title', t('obLocTitle'));
  setText('ob-loc-desc', t('obLocDesc'));
  setText('ob-notif-title', t('obNotifTitle'));
  setText('ob-notif-desc', t('obNotifDesc'));
  setText('ob-start-txt', t('obStart'));
  setText('ob-skip-txt', t('obSkip'));
  setText('city-title', t('cityTitle'));
  setText('autoLocTxt', t('autoLoc'));
  setAttr('citySearch', 'placeholder', t('citySearch'));

  // Install steps
  renderInstallSteps();

  // Home
  setText('ctLabel', t('ctLabel'));
  setText('dayLbl', t('dayLbl'));
  setText('nc-label', t('ncLabel'));
  setText('nc-alert-btn', t('ncAlertBtn'));
  setText('home-imsakiya-title', t('imsakiyaTitle'));
  setText('wird-title', t('wirdTitle'));

  // Notif
  setText('nh-title', t('nhTitle'));
  setText('ns1-title', t('ns1'));
  setText('ns2-title', t('ns2'));
  setText('suhoor-label', t('suhoor'));
  setText('qiyam-label', t('qiyam'));
  setText('iftar-label', t('iftar'));
  setText('dhikr-label', t('dhikr'));
  setText('suhoor-time-lbl', t('timeLabel'));
  setText('qiyam-time-lbl', t('timeLabel'));

  // Quran
  setText('khatm-count-title', t('khatmCount'));
  setText('kDailyLbl', t('daily'));
  setText('kDaysLbl', t('daysLeft'));
  const tabs = t('khatmTabs');
  tabs.forEach((txt, i) => setText(`ktab-${i+1}`, txt));
  setText('ach-title', t('achTitle'));
  setText('qm-done-txt', t('qmDone'));

  // Settings
  setText('settings-heading', t('settingsH'));
  setText('sc-loc-title', t('scLoc'));
  setText('sc-loc-btn', t('scLocBtn'));
  setText('sc-method-title', t('scMethod'));
  setText('sc-method-desc', t('scMethodDesc'));
  setText('sc-perm-title', t('scPerm'));
  setText('sc-perm-info', t('scPermInfo'));
  setText('sc-perm-btn', t('scPermBtn'));
  setText('sc-data-title', t('scData'));
  setText('sc-data-info', t('scDataInfo'));

  // Nav
  setText('nav-home-txt', t('navHome'));
  setText('nav-notif-txt', t('navNotif'));
  setText('nav-quran-txt', t('navQuran'));
  setText('nav-settings-txt', t('navSettings'));

  // Install bar
  setText('ib-title', t('ibTitle'));
  setText('ib-sub', t('ibSub'));
  setText('ib-btn-txt', t('ibBtn'));

  // Re-render dynamic content
  if (S.prayers.Fajr) {
    renderPrayerList();
    renderNotifPanel();
    updateQuranUI();
    updateCountdown();
    updateLocationDisplay();
  }
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}
function setAttr(id, attr, val) {
  const el = document.getElementById(id);
  if (el) el[attr] = val;
}

function toggleLang() {
  S.lang = S.lang === 'ar' ? 'en' : 'ar';
  savePersist();
  applyLang();
  trackLang(S.lang);
}

function renderInstallSteps() {
  const andEl = document.getElementById('steps-android');
  const iosEl = document.getElementById('steps-ios');
  if (!andEl) return;
  andEl.innerHTML = t('androidSteps').map((s,i) => `
    <div class="install-step-item">
      <div class="install-step-num">${i+1}</div>
      <div class="install-step-text">${s}</div>
    </div>`).join('');
  iosEl.innerHTML = t('iosSteps').map((s,i) => `
    <div class="install-step-item">
      <div class="install-step-num">${i+1}</div>
      <div class="install-step-text">${s}</div>
    </div>`).join('');
}

function switchInstallTab(tab) {
  document.getElementById('tab-android').classList.toggle('active', tab==='android');
  document.getElementById('tab-ios').classList.toggle('active', tab==='ios');
  document.getElementById('steps-android').classList.toggle('active', tab==='android');
  document.getElementById('steps-ios').classList.toggle('active', tab==='ios');
}

// =============================================================
// ONBOARDING
// =============================================================
function showOnboarding() {
  document.getElementById('onboardOverlay').classList.remove('hidden');
  checkPermStatuses();
}
function hideOnboarding() {
  document.getElementById('onboardOverlay').classList.add('hidden');
}

function checkPermStatuses() {
  // Location
  if (navigator.permissions) {
    navigator.permissions.query({name:'geolocation'}).then(r => {
      document.getElementById('locStatus').textContent = r.state === 'granted' ? 'âœ…' : (r.state === 'denied' ? 'âŒ' : 'â¬œ');
    });
    navigator.permissions.query({name:'notifications'}).then(r => {
      document.getElementById('notifStatus').textContent = r.state === 'granted' ? 'âœ…' : (r.state === 'denied' ? 'âŒ' : 'â¬œ');
    });
  }
  if (Notification && Notification.permission === 'granted') document.getElementById('notifStatus').textContent = 'âœ…';
  // Hide install instructions if already installed
  if (isStandalone()) document.getElementById('installInstructions').style.display = 'none';
}

async function startApp() {
  hideOnboarding();
  // Show loading screen now that user has interacted
  document.getElementById('loadingScreen').classList.remove('gone');
  document.getElementById('loadingScreen').style.display = '';
  // Request location (will fetch prayer times inside)
  await tryAutoLocation(true);
  // Request notifications
  await askNotifPermission(true);
}

function skipOnboard() {
  hideOnboarding();
  S.initialized = true;
  savePersist();
  if (S.lat) {
    // Already have coords from background GPS â†’ fetch now
    fetchPrayerTimes();
  } else {
    hideLoading();
    openCitySelector();
  }
}

// =============================================================
// PERMISSIONS
// =============================================================
async function tryAutoLocation(silent = false) {
  if (!navigator.geolocation) {
    if (!silent) showToast(t('toastLocFail'));
    openCitySelector();
    return;
  }
  return new Promise(resolve => {
    navigator.geolocation.getCurrentPosition(
      pos => {
        S.lat = pos.coords.latitude;
        S.lng = pos.coords.longitude;
        // Auto-detect calculation method from nearest city
        const nearest = findNearestCity(S.lat, S.lng);
        if (nearest) {
          S.method = nearest.method;
          document.getElementById('methodSelect').value = nearest.method;
        }
        document.getElementById('locStatus').textContent = 'âœ…';
        reverseGeocode().then(() => {
          fetchPrayerTimes();
          if (!silent) showToast(t('toastLocOk'));
          S.initialized = true;
          savePersist();
          closeCitySelector();
          resolve();
        });
      },
      () => {
        document.getElementById('locStatus').textContent = 'âŒ';
        if (!silent) showToast(t('toastLocFail'));
        openCitySelector();
        resolve();
      },
      { timeout: 10000, maximumAge: 300000 }
    );
  });
}

async function reverseGeocode() {
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${S.lat}&lon=${S.lng}&format=json&accept-language=ar,en`);
    const d = await r.json();
    const city = d.address?.city || d.address?.town || d.address?.county || d.address?.state || '';
    const country = d.address?.country || '';
    S.cityName = city ? `${city}ØŒ ${country}` : country;
    S.cityNameEn = city ? `${city}, ${country}` : country;
    updateLocationDisplay();
  } catch(e) {
    S.cityName = 'Ù…ÙˆÙ‚Ø¹Ùƒ'; S.cityNameEn = 'Your Location';
    updateLocationDisplay();
  }
}

async function askNotifPermission(silent = false) {
  if (!('Notification' in window)) return;
  if (Notification.permission === 'granted') {
    document.getElementById('notifStatus').textContent = 'âœ…';
    return;
  }
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    document.getElementById('notifStatus').textContent = 'âœ…';
    if (!silent) showToast(t('toastNotifGranted'));
    scheduleNotifications();
  } else {
    document.getElementById('notifStatus').textContent = 'âŒ';
    if (!silent) showToast(t('toastNotifDenied'));
  }
}

// =============================================================
// CITY SELECTOR
// =============================================================
let filteredCities = [...CITIES];

function openCitySelector() {
  closeSideEffects();
  document.getElementById('cityOverlay').classList.remove('hidden');
  document.getElementById('citySearch').value = '';
  filterCities('');
}
function closeCitySelector() {
  document.getElementById('cityOverlay').classList.add('hidden');
}

function filterCities(q) {
  const lq = q.toLowerCase().trim();
  filteredCities = lq
    ? CITIES.filter(c =>
        c.name.includes(q) ||
        c.nameEn.toLowerCase().includes(lq) ||
        c.country.includes(q) ||
        c.countryEn.toLowerCase().includes(lq)
      )
    : [...CITIES];
  renderCityList();
}

function renderCityList() {
  const el = document.getElementById('cityList');
  if (!filteredCities.length) {
    el.innerHTML = `<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:13px">${S.lang==='ar'?'Ù„Ø§ Ù†ØªØ§Ø¦Ø¬':'No results'}</div>`;
    return;
  }

  // Group by country
  const groups = {};
  filteredCities.forEach(c => {
    const grp = S.lang === 'ar' ? c.country : c.countryEn;
    if (!groups[grp]) groups[grp] = [];
    groups[grp].push(c);
  });

  let html = '';
  Object.entries(groups).forEach(([grp, cities]) => {
    html += `<div class="city-group-title">${cities[0].flag} ${grp}</div>`;
    cities.forEach(c => {
      const name = S.lang === 'ar' ? c.name : c.nameEn;
      const method = methodName(c.method);
      html += `
        <div class="city-item" onclick="selectCity(${CITIES.indexOf(c)})">
          <div class="city-item-info">
            <h4>${name}</h4>
            <p>${S.lang==='ar' ? c.country : c.countryEn}</p>
          </div>
          <span class="city-item-method">${method}</span>
        </div>`;
    });
  });
  el.innerHTML = html;
}

function methodName(m) {
  const names = {4:'Umm Al-Qura',16:'Dubai',8:'Gulf',3:'Egypt',12:'Diyanet',2:'ISNA',5:'Karachi',1:'KHI',11:'MWL',7:'Tehran',20:'KEMENAG'};
  return names[m] || `Method ${m}`;
}

function selectCity(idx) {
  const c = CITIES[idx];
  S.lat = c.lat; S.lng = c.lng;
  S.cityName = c.name; S.cityNameEn = c.nameEn;
  S.method = c.method;
  document.getElementById('methodSelect').value = c.method;
  S.initialized = true;
  savePersist();
  updateLocationDisplay();
  closeCitySelector();
  trackCity(c.nameEn || c.name);
  fetchPrayerTimes();
  showToast(`ğŸ“ ${S.lang==='ar' ? c.name : c.nameEn}`);
}

function updateLocationDisplay() {
  const name = S.lang === 'ar' ? S.cityName : S.cityNameEn;
  setText('locDisplay', name || (S.lang==='ar' ? 'Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†ØªÙƒ' : 'Choose city'));
  const info = `${S.lat ? S.lat.toFixed(4) : '-'}, ${S.lng ? S.lng.toFixed(4) : '-'} â€” ${name}`;
  setText('sc-loc-info', info);
}

// =============================================================
// PRAYER TIMES (Aladhan API)
// =============================================================
async function fetchPrayerTimes() {
  if (!S.lat) return;
  const method = S.method || document.getElementById('methodSelect').value;
  const now = new Date();
  const dateStr = `${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`;
  try {
    const url = `https://api.aladhan.com/v1/timings/${dateStr}?latitude=${S.lat}&longitude=${S.lng}&method=${method}&school=0`;
    const r = await fetch(url);
    const d = await r.json();
    if (d.code === 200) {
      const tm = d.data.timings;
      S.prayers = { Fajr:tm.Fajr, Sunrise:tm.Sunrise, Dhuhr:tm.Dhuhr, Asr:tm.Asr, Maghrib:tm.Maghrib, Isha:tm.Isha };
      const hj = d.data.date.hijri;
      S.ramadanDay = parseInt(hj.day) || 1;
      S.hijri = `${hj.day} ${hj.month.ar} ${hj.year} Ù‡Ù€`;
      Object.entries(S.prayers).forEach(([n,v]) => { S.timestamps[n] = toMs(v); });
      setText('hijriDisplay', S.hijri);
      setText('nh-sub', `${S.lang==='ar'?'Ø§Ù„ÙŠÙˆÙ…':'Day'} ${numStr(S.ramadanDay)} ${S.lang==='ar'?'Ø±Ù…Ø¶Ø§Ù†':'Ramadan'}`);
      setText('settingsRamadanDay', numStr(S.ramadanDay));
      renderPrayerList();
      renderNotifPanel();
      updateQuranUI();
      scheduleNotifications();
    }
  } catch(e) {
    console.error(e);
    showToast('âŒ ' + (S.lang==='ar'?'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª':'Failed to load prayer times'));
  }
  hideLoading();
}

function onMethodChange() {
  S.method = parseInt(document.getElementById('methodSelect').value);
  savePersist();
  fetchPrayerTimes();
}

// =============================================================
// COUNTDOWN
// =============================================================
function updateCountdown() {
  const now = Date.now();
  const mag = S.timestamps['Maghrib'];
  const fajr = S.timestamps['Fajr'];
  let target, lbl, sub;

  if (mag && now < mag) {
    target = mag; lbl = t('ctLabel'); sub = t('ctSub');
  } else if (fajr) {
    target = fajr + 24*3600000 - 10*60000;
    lbl = t('ctLabelSuhoor'); sub = t('ctSubSuhoor');
  } else return;

  setText('ctLabel', lbl);
  setText('ctSub', sub);

  const diff = Math.max(0, target - now);
  const h = Math.floor(diff/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const s = Math.floor((diff%60000)/1000);
  const timeStr = S.lang==='ar'
    ? `${toAr(String(h).padStart(2,'0'))}:${toAr(String(m).padStart(2,'0'))}:${toAr(String(s).padStart(2,'0'))}`
    : `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  setText('ctTime', timeStr);

  // Ring
  const offset = 553 * (1 - Math.min(1, 1 - diff/(24*3600000)));
  const ring = document.getElementById('ringProg');
  if (ring) ring.style.strokeDashoffset = offset;

  // Day bar
  const dayStart = new Date(); dayStart.setHours(0,0,0,0);
  const pct = Math.round((now - dayStart.getTime()) / (24*3600000) * 100);
  const fill = document.getElementById('dayFill');
  if (fill) fill.style.width = pct + '%';
  setText('dayPct', numStr(pct) + '%');

  // Next prayer countdown
  if (S.nextPrayer) {
    const nd = Math.max(0, S.timestamps[S.nextPrayer] - now);
    const nh = Math.floor(nd/3600000);
    const nm = Math.floor((nd%3600000)/60000);
    const remStr = S.lang==='ar'
      ? `${t('ncRem')} ${toAr(String(nh).padStart(2,'0'))}:${toAr(String(nm).padStart(2,'0'))}`
      : `${t('ncRem')} ${String(nh).padStart(2,'0')}:${String(nm).padStart(2,'0')}`;
    setText('nc-rem', remStr);
  }
}

// =============================================================
// PRAYER LIST
// =============================================================
function renderPrayerList() {
  const now = Date.now();
  let nextKey = null, nextTs = Infinity;
  Object.entries(S.timestamps).forEach(([n,ts]) => {
    if (ts > now && ts < nextTs) { nextTs = ts; nextKey = n; }
  });
  S.nextPrayer = nextKey;

  if (nextKey) {
    setText('nc-name', t('prayerNames')[nextKey]);
    setText('nc-time', fmt12(S.prayers[nextKey]));
  }

  const order = ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'];
  const list = document.getElementById('prayerList');
  if (!list) return;
  list.innerHTML = order.map(n => `
    <div class="prayer-row${n===nextKey?' cur':''}">
      <div class="pr-left">
        <div class="pr-icon">${PRAYER_ICONS[n]}</div>
        <div>
          <div class="pr-name">${t('prayerNames')[n]}</div>
          <div class="pr-en">${n}</div>
        </div>
      </div>
      <div class="pr-right">
        <span class="cur-badge">${S.lang==='ar'?'Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©':'Next'}</span>
        <div class="pr-time">${fmt12(S.prayers[n])}</div>
      </div>
    </div>`).join('');

  // Wird
  const pg = Math.ceil(QURAN_PAGES/RAMADAN_DAYS * (S.ramadanDay-1)) + 1;
  const s = getSurahForPage(pg);
  setText('wird-sub', `${t('surahLabel')} ${S.lang==='ar'?s.nameAr:s.nameEn} - ${S.lang==='ar'?t('page')+' '+numStr(pg):'Page '+pg}`);
}

// =============================================================
// NOTIFICATIONS PANEL
// =============================================================
function renderNotifPanel() {
  const card = document.getElementById('prayerNotifCard');
  if (!card) return;
  const prayers = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  card.innerHTML = prayers.map(n => {
    const enabled = S.notifSettings[n] !== false;
    return `
      <div class="notif-row">
        <div class="nr-left">
          <div class="nr-icon" style="background:rgba(37,99,235,.15)">${PRAYER_ICONS[n]}</div>
          <div>
            <div class="nr-title">${t('prayerNamesShort')[n]}</div>
            <div class="nr-sub">${n} Â· ${fmt12(S.prayers[n])}</div>
          </div>
        </div>
        <label class="toggle">
          <input type="checkbox" ${enabled?'checked':''} onchange="togglePrayerNotif('${n}',this.checked)">
          <span class="tslider"></span>
        </label>
      </div>`;
  }).join('');

  // Restore special toggles
  const ns = S.notifSettings;
  const ids = ['suhoor','qiyam','iftar','dhikr'];
  ids.forEach(id => {
    const tog = document.getElementById(`tog-${id}`);
    if (tog) tog.checked = !!ns[id];
    const tp = document.getElementById(`tp-${id}`);
    if (tp) tp.classList.toggle('show', !!ns[id]);
    const ti = document.getElementById(`time-${id}`);
    if (ti && ns[`${id}Time`]) ti.value = ns[`${id}Time`];
  });
}

function togglePrayerNotif(name, enabled) {
  S.notifSettings[name] = enabled;
  savePersist();
  scheduleNotifications();
  showToast(enabled ? t('toastNotifOn') : t('toastNotifOff'));
}

function saveAlarm(type) {
  const tog = document.getElementById(`tog-${type}`);
  const tp = document.getElementById(`tp-${type}`);
  const ti = document.getElementById(`time-${type}`);
  if (tog) { S.notifSettings[type] = tog.checked; if (tp) tp.classList.toggle('show', tog.checked); }
  if (ti) S.notifSettings[`${type}Time`] = ti.value;
  savePersist();
  scheduleNotifications();
}

// =============================================================
// NOTIFICATIONS SCHEDULING
// =============================================================
// â”€â”€â”€ Build the full alarm data object â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAlarmData() {
  const now = Date.now();
  const ns  = S.notifSettings;
  const data = {};

  ['Fajr','Dhuhr','Asr','Maghrib','Isha'].forEach(n => {
    if (ns[n] === false) return;
    const ts = S.timestamps[n];
    if (ts && ts > now) {
      data[n] = { time: ts, title: t('prayerNamesShort')[n], body: fmt12(S.prayers[n]) };
    }
  });

  const mkAlarm = (key, defaultTs, body) => {
    if (!ns[key]) return;
    const tStr = ns[`${key}Time`];
    let ts = defaultTs;
    if (tStr) {
      const [h,m] = tStr.split(':').map(Number);
      const d = new Date(); d.setHours(h,m,0,0);
      ts = d.getTime();
    }
    if (ts > now) data[key] = { time: ts, title: t(key), body };
  };

  mkAlarm('suhoor', (S.timestamps['Fajr']||0) - 30*60000, S.lang==='ar'?'Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø³Ø­ÙˆØ±':'Time for Suhoor');
  mkAlarm('qiyam',  (S.timestamps['Isha']||0) + 3*3600000, S.lang==='ar'?'Ù‚Ù… ÙˆØµÙ„Ù‘ Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„':'Time for Qiyam');
  if (ns['iftar'] && S.timestamps['Maghrib']) {
    const ts = S.timestamps['Maghrib'] - 5*60000;
    if (ts > now) data['iftar'] = {
      time: ts, title: t('iftar'),
      body: S.lang==='ar' ? `Ø§Ù„Ø¥ÙØ·Ø§Ø± Ø¨Ø¹Ø¯ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚ - ${fmt12(S.prayers['Maghrib'])}` : `Iftar in 5 min - ${fmt12(S.prayers['Maghrib'])}`
    };
  }
  return data;
}

// â”€â”€â”€ Layer 1: send to SW (works when app is closed on Android) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendAlarmsToSW(data) {
  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) return;
  navigator.serviceWorker.controller.postMessage({ type: 'SCHEDULE_NOTIFICATIONS', prayers: data });
}

// â”€â”€â”€ Layer 2: main-thread timers (guaranteed when app/tab is open) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _mainTimers = {};
function scheduleMainThreadAlarms(data) {
  const soundKeys = ['Fajr','Dhuhr','Asr','Maghrib','Isha','suhoor','qiyam'];
  // clear old timers
  Object.keys(_mainTimers).forEach(k => { clearTimeout(_mainTimers[k]); delete _mainTimers[k]; });

  Object.entries(data).forEach(([name, info]) => {
    const diff = info.time - Date.now();
    if (diff <= 0 || diff > 24*3600*1000) return;
    _mainTimers[name] = setTimeout(() => {
      // Fire notification directly from main thread (no SW needed)
      if (Notification.permission === 'granted') {
        try { new Notification(info.title, { body: info.body, icon: './icon-192.png', tag: name }); } catch(e) {}
      }
      // Play azan if this is a prayer
      if (soundKeys.includes(name)) {
        playAzan(info.title, info.body);
      }
    }, diff);
  });
}

// â”€â”€â”€ Layer 3: minute-checker fallback (catches anything that slipped through) â”€
let _lastFiredKey = '';
function checkMissedAlarms() {
  const data = buildAlarmData();
  const now  = Date.now();
  // Check anything within the last 90 seconds that we haven't fired yet
  // (covers cases where setTimeout fired late or tab was backgrounded)
  Object.entries(data).forEach(([name, info]) => {
    const ago = now - info.time;
    if (ago >= 0 && ago < 90000) {
      const key = name + ':' + info.time;
      if (_lastFiredKey === key) return; // already handled
      _lastFiredKey = key;
      const soundKeys = ['Fajr','Dhuhr','Asr','Maghrib','Isha','suhoor','qiyam'];
      if (Notification.permission === 'granted') {
        try { new Notification(info.title, { body: info.body, icon: './icon-192.png', tag: name }); } catch(e) {}
      }
      if (soundKeys.includes(name)) playAzan(info.title, info.body);
    }
  });
}

// â”€â”€â”€ Main entry: schedule on all layers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleNotifications() {
  if (Notification.permission !== 'granted') return;
  if (!S.prayers || !S.prayers.Fajr) return;
  const data = buildAlarmData();
  sendAlarmsToSW(data);
  scheduleMainThreadAlarms(data);
}

// =============================================================
// QURAN KHATM
// =============================================================
const SURAH_STARTS = [
  [1,1,'Ø§Ù„ÙØ§ØªØ­Ø©','Al-Fatiha'],[2,2,'Ø§Ù„Ø¨Ù‚Ø±Ø©','Al-Baqarah'],[3,50,'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†','Ali Imran'],
  [4,77,'Ø§Ù„Ù†Ø³Ø§Ø¡','An-Nisa'],[5,106,'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©','Al-Maidah'],[6,128,'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…','Al-Anam'],
  [7,151,'Ø§Ù„Ø£Ø¹Ø±Ø§Ù','Al-Araf'],[8,177,'Ø§Ù„Ø£Ù†ÙØ§Ù„','Al-Anfal'],[9,187,'Ø§Ù„ØªÙˆØ¨Ø©','At-Tawbah'],
  [10,208,'ÙŠÙˆÙ†Ø³','Yunus'],[11,221,'Ù‡ÙˆØ¯','Hud'],[12,235,'ÙŠÙˆØ³Ù','Yusuf'],
  [13,249,'Ø§Ù„Ø±Ø¹Ø¯','Ar-Rad'],[14,255,'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…','Ibrahim'],[15,262,'Ø§Ù„Ø­Ø¬Ø±','Al-Hijr'],
  [16,267,'Ø§Ù„Ù†Ø­Ù„','An-Nahl'],[17,282,'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡','Al-Isra'],[18,293,'Ø§Ù„ÙƒÙ‡Ù','Al-Kahf'],
  [19,305,'Ù…Ø±ÙŠÙ…','Maryam'],[20,312,'Ø·Ù‡','Ta-Ha'],[21,322,'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡','Al-Anbiya'],
  [22,332,'Ø§Ù„Ø­Ø¬','Al-Hajj'],[23,342,'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†','Al-Muminun'],[24,350,'Ø§Ù„Ù†ÙˆØ±','An-Nur'],
  [25,359,'Ø§Ù„ÙØ±Ù‚Ø§Ù†','Al-Furqan'],[26,367,'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡','Ash-Shuara'],[27,377,'Ø§Ù„Ù†Ù…Ù„','An-Naml'],
  [28,385,'Ø§Ù„Ù‚ØµØµ','Al-Qasas'],[29,396,'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª','Al-Ankabut'],[30,404,'Ø§Ù„Ø±ÙˆÙ…','Ar-Rum'],
  [31,411,'Ù„Ù‚Ù…Ø§Ù†','Luqman'],[32,415,'Ø§Ù„Ø³Ø¬Ø¯Ø©','As-Sajdah'],[33,418,'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨','Al-Ahzab'],
  [34,428,'Ø³Ø¨Ø£','Saba'],[35,434,'ÙØ§Ø·Ø±','Fatir'],[36,440,'ÙŠØ³','Yaseen'],
  [37,446,'Ø§Ù„ØµØ§ÙØ§Øª','As-Saffat'],[38,453,'Øµ','Sad'],[39,458,'Ø§Ù„Ø²Ù…Ø±','Az-Zumar'],
  [40,467,'ØºØ§ÙØ±','Ghafir'],[41,477,'ÙØµÙ„Øª','Fussilat'],[42,483,'Ø§Ù„Ø´ÙˆØ±Ù‰','Ash-Shura'],
  [43,489,'Ø§Ù„Ø²Ø®Ø±Ù','Az-Zukhruf'],[44,496,'Ø§Ù„Ø¯Ø®Ø§Ù†','Ad-Dukhan'],[45,499,'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©','Al-Jathiyah'],
  [46,502,'Ø§Ù„Ø£Ø­Ù‚Ø§Ù','Al-Ahqaf'],[47,507,'Ù…Ø­Ù…Ø¯','Muhammad'],[48,511,'Ø§Ù„ÙØªØ­','Al-Fath'],
  [49,515,'Ø§Ù„Ø­Ø¬Ø±Ø§Øª','Al-Hujurat'],[50,518,'Ù‚','Qaf'],[51,520,'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª','Adh-Dhariyat'],
  [52,523,'Ø§Ù„Ø·ÙˆØ±','At-Tur'],[53,526,'Ø§Ù„Ù†Ø¬Ù…','An-Najm'],[54,528,'Ø§Ù„Ù‚Ù…Ø±','Al-Qamar'],
  [55,531,'Ø§Ù„Ø±Ø­Ù…Ù†','Ar-Rahman'],[56,534,'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©','Al-Waqiah'],[57,537,'Ø§Ù„Ø­Ø¯ÙŠØ¯','Al-Hadid'],
  [58,542,'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©','Al-Mujadila'],[59,545,'Ø§Ù„Ø­Ø´Ø±','Al-Hashr'],[60,549,'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©','Al-Mumtahanah'],
  [61,551,'Ø§Ù„ØµÙ','As-Saf'],[62,553,'Ø§Ù„Ø¬Ù…Ø¹Ø©','Al-Jumua'],[63,554,'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†','Al-Munafiqun'],
  [64,556,'Ø§Ù„ØªØºØ§Ø¨Ù†','At-Taghabun'],[65,558,'Ø§Ù„Ø·Ù„Ø§Ù‚','At-Talaq'],[66,560,'Ø§Ù„ØªØ­Ø±ÙŠÙ…','At-Tahrim'],
  [67,562,'Ø§Ù„Ù…Ù„Ùƒ','Al-Mulk'],[68,564,'Ø§Ù„Ù‚Ù„Ù…','Al-Qalam'],[69,566,'Ø§Ù„Ø­Ø§Ù‚Ø©','Al-Haqqah'],
  [70,568,'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬','Al-Maarij'],[71,570,'Ù†ÙˆØ­','Nuh'],[72,572,'Ø§Ù„Ø¬Ù†','Al-Jinn'],
  [73,574,'Ø§Ù„Ù…Ø²Ù…Ù„','Al-Muzzammil'],[74,575,'Ø§Ù„Ù…Ø¯Ø«Ø±','Al-Muddaththir'],[75,577,'Ø§Ù„Ù‚ÙŠØ§Ù…Ø©','Al-Qiyamah'],
  [76,578,'Ø§Ù„Ø¥Ù†Ø³Ø§Ù†','Al-Insan'],[77,580,'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª','Al-Mursalat'],[78,582,'Ø§Ù„Ù†Ø¨Ø£','An-Naba'],
  [79,584,'Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª','An-Naziat'],[80,585,'Ø¹Ø¨Ø³','Abasa'],[81,586,'Ø§Ù„ØªÙƒÙˆÙŠØ±','At-Takwir'],
  [82,587,'Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±','Al-Infitar'],[83,587,'Ø§Ù„Ù…Ø·ÙÙÙŠÙ†','Al-Mutaffifin'],[84,589,'Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚','Al-Inshiqaq'],
  [85,590,'Ø§Ù„Ø¨Ø±ÙˆØ¬','Al-Buruj'],[86,591,'Ø§Ù„Ø·Ø§Ø±Ù‚','At-Tariq'],[87,591,'Ø§Ù„Ø£Ø¹Ù„Ù‰','Al-Ala'],
  [88,592,'Ø§Ù„ØºØ§Ø´ÙŠØ©','Al-Ghashiyah'],[89,593,'Ø§Ù„ÙØ¬Ø±','Al-Fajr'],[90,594,'Ø§Ù„Ø¨Ù„Ø¯','Al-Balad'],
  [91,595,'Ø§Ù„Ø´Ù…Ø³','Ash-Shams'],[92,595,'Ø§Ù„Ù„ÙŠÙ„','Al-Layl'],[93,596,'Ø§Ù„Ø¶Ø­Ù‰','Ad-Duhaa'],
  [94,596,'Ø§Ù„Ø´Ø±Ø­','Ash-Sharh'],[95,597,'Ø§Ù„ØªÙŠÙ†','At-Tin'],[96,597,'Ø§Ù„Ø¹Ù„Ù‚','Al-Alaq'],
  [97,598,'Ø§Ù„Ù‚Ø¯Ø±','Al-Qadr'],[98,598,'Ø§Ù„Ø¨ÙŠÙ†Ø©','Al-Bayyinah'],[99,599,'Ø§Ù„Ø²Ù„Ø²Ù„Ø©','Az-Zalzalah'],
  [100,599,'Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª','Al-Adiyat'],[101,600,'Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©','Al-Qariah'],[102,601,'Ø§Ù„ØªÙƒØ§Ø«Ø±','At-Takathur'],
  [103,601,'Ø§Ù„Ø¹ØµØ±','Al-Asr'],[104,601,'Ø§Ù„Ù‡Ù…Ø²Ø©','Al-Humazah'],[105,602,'Ø§Ù„ÙÙŠÙ„','Al-Fil'],
  [106,602,'Ù‚Ø±ÙŠØ´','Quraysh'],[107,602,'Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†','Al-Maun'],[108,603,'Ø§Ù„ÙƒÙˆØ«Ø±','Al-Kawthar'],
  [109,603,'Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†','Al-Kafirun'],[110,603,'Ø§Ù„Ù†ØµØ±','An-Nasr'],[111,604,'Ø§Ù„Ù…Ø³Ø¯','Al-Masad'],
  [112,604,'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ','Al-Ikhlas'],[113,604,'Ø§Ù„ÙÙ„Ù‚','Al-Falaq'],[114,604,'Ø§Ù„Ù†Ø§Ø³','An-Nas']
];

function getSurahForPage(pg) {
  let res = { nameAr:'Ø§Ù„ÙØ§ØªØ­Ø©', nameEn:'Al-Fatiha' };
  for (const [,start,ar,en] of SURAH_STARTS) {
    if (pg >= start) res = { nameAr: ar, nameEn: en };
    else break;
  }
  return res;
}

function updateQuranUI() {
  const { khatmat, ramadanDay, completedSessions } = S;
  const totalPg = QURAN_PAGES * khatmat;
  const pgPerDay = totalPg / RAMADAN_DAYS;
  const done = countDonePages(pgPerDay);
  const pct = Math.min(100, Math.round(done / totalPg * 100));
  const daysLeft = Math.max(0, RAMADAN_DAYS - ramadanDay + 1);
  const daily = Math.ceil(pgPerDay);

  // Ring
  const el = document.getElementById('kringProg');
  if (el) el.style.strokeDashoffset = 465 * (1 - pct/100);
  setText('kPct', numStr(pct));
  setText('kSub', `${t('completed')} ${numStr(Math.round(done))} ${t('page')}`);

  // Level
  const levels = t('levels');
  let lv = levels[0][1];
  for (const [th,nm] of levels) { if (pct >= th) lv = nm; }
  setText('kLevel', lv);

  // Stats
  const dailyEl = document.getElementById('kDaily');
  if (dailyEl) dailyEl.innerHTML = `${numStr(daily)}<span id="kDaily-unit"> ${t('page')}</span>`;
  const daysEl = document.getElementById('kDays');
  if (daysEl) daysEl.innerHTML = `${numStr(daysLeft)}<span id="kDays-unit"> ${t('day')}</span>`;

  // Plan
  setText('today-plan-title', `${t('todayPlan')} (${t('dayWord')} ${numStr(ramadanDay)})`);
  renderPlan(pgPerDay);
  renderAchievements(pct);
}

function countDonePages(pgPerDay) {
  let total = 0;
  Object.keys(S.completedSessions).forEach(k => {
    if (S.completedSessions[k]) total += pgPerDay / 2;
  });
  return total;
}

function renderPlan(pgPerDay) {
  const card = document.getElementById('planCard');
  if (!card) return;
  const { khatmat, ramadanDay } = S;

  // Absolute page range for today across ALL khatms combined
  // khatmat=1: pgPerDayâ‰ˆ20  â†’  day1 = abs 1-20
  // khatmat=2: pgPerDayâ‰ˆ40  â†’  day1 = abs 1-40 (pages 1-40 of Quran)
  // khatmat=3: pgPerDayâ‰ˆ60  â†’  day1 = abs 1-60
  // When abs page > 604 it wraps back to page 1 (next khatm)
  const dayAbsStart = Math.floor((ramadanDay - 1) * pgPerDay) + 1;
  const dayAbsEnd   = Math.min(Math.floor(ramadanDay * pgPerDay), QURAN_PAGES * khatmat);
  const mid         = Math.floor((dayAbsStart + dayAbsEnd) / 2);

  // Convert absolute page to actual Quran page (1-604) + khatm number
  const absToQuran = (absP) => ({
    kNum:  Math.floor((absP - 1) / QURAN_PAGES) + 1,
    qPage: ((absP - 1) % QURAN_PAGES) + 1
  });

  const s1 = absToQuran(dayAbsStart);
  const e1 = absToQuran(mid);
  const s2 = absToQuran(mid + 1);
  const e2 = absToQuran(dayAbsEnd);

  const key1 = `${ramadanDay}-1`, key2 = `${ramadanDay}-2`;
  const d1 = !!S.completedSessions[key1];
  const d2 = !!S.completedSessions[key2];

  const items = [
    { key: key1, absS: dayAbsStart, absE: mid,       qS: s1.qPage, qE: e1.qPage, kNum: s1.kNum, surah: getSurahForPage(s1.qPage), done: d1 },
    { key: key2, absS: mid + 1,     absE: dayAbsEnd, qS: s2.qPage, qE: e2.qPage, kNum: s2.kNum, surah: getSurahForPage(s2.qPage), done: d2 }
  ];

  card.innerHTML = items.map(it => {
    const surahName = S.lang === 'ar' ? it.surah.nameAr : it.surah.nameEn;
    const kLabel = khatmat > 1 ? ` Â· ${t('khatmLabel')} ${numStr(it.kNum)}` : '';
    return `
      <div class="plan-item">
        <div>
          <div class="pi-range">${t('pagesFrom')} ${numStr(it.qS)} ${t('pagesTo')} ${numStr(it.qE)}</div>
          <div class="pi-surah">${t('surahLabel')} ${surahName}${kLabel}</div>
        </div>
        <div class="pi-right">
          ${it.done ? '<div class="pi-done">âœ“</div>' : ''}
          <button class="pi-btn${it.done ? ' done' : ''}" onclick="openSession('${it.key}',${it.absS},${it.absE})">
            ${it.done ? t('doneBtn') : t('readBtn')}
          </button>
        </div>
      </div>`;
  }).join('');
}

function renderAchievements(pct) {
  const grid = document.getElementById('achGrid');
  if (!grid) return;
  grid.innerHTML = t('achievements').map(a => `
    <div class="ach-item ${pct>=a.t?'earned':''}">
      <div class="ach-icon">${a.icon}</div>
      <div class="ach-name">${a.name}</div>
    </div>`).join('');
}

function setKhatmat(n) {
  S.khatmat = n;
  savePersist();
  document.querySelectorAll('.ks-tab').forEach((t,i) => t.classList.toggle('active', i===n-1));
  updateQuranUI();
  showToast(`âœ… ${numStr(n)} ${S.lang==='ar'?'Ø®ØªÙ…Ø©':'Khatm(s)'}`);
}

// =============================================================
// QURAN SESSION VIEWER
// =============================================================
let curSession=null, curPage=1, sesStart=1, sesEnd=1;

function openSession(key, start, end) {
  curSession=key; sesStart=start; sesEnd=end; curPage=start;
  document.getElementById('qmodal').classList.add('show');
  loadQPage(curPage);
}

function loadQPage(absPage) {
  // Convert absolute page (can be > 604 for multiple khatms) to real Quran page 1-604
  const pg = ((absPage - 1) % QURAN_PAGES) + 1;
  const kNum = Math.floor((absPage - 1) / QURAN_PAGES) + 1;

  const body = document.getElementById('qmBody');
  const p3 = String(pg).padStart(3, '0');
  const url = `https://raw.githubusercontent.com/QuranHub/quran-pages-images/main/ayat/hafs/${p3}.png`;
  const surah = getSurahForPage(pg);
  const surahName = S.lang === 'ar' ? surah.nameAr : surah.nameEn;
  const kLabel = S.khatmat > 1 ? ` Â· ${t('khatmLabel')} ${numStr(kNum)}` : '';
  setText('qmTitle', `${S.lang === 'ar' ? 'ØµÙØ­Ø©' : 'Page'} ${numStr(pg)} â€¢ ${t('surahLabel')} ${surahName}${kLabel}`);

  body.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:28px;margin-bottom:10px">â³</div>${S.lang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'Loading...'}</div>`;

  function showImg(src) {
    const wrap = document.createElement('div');
    wrap.className = 'qm-img-wrap';
    const img = document.createElement('img');
    img.className = 'qm-img';
    img.alt = `Page ${pg}`;
    img.onload = () => {
      body.innerHTML = '';
      // Tap hint overlays (shown briefly, only if not first page)
      if (curPage > sesStart) {
        const hintL = document.createElement('div');
        hintL.className = 'tap-hint left';
        hintL.textContent = S.lang === 'ar' ? 'â—€' : 'â—€';
        wrap.appendChild(hintL);
        setTimeout(() => hintL.classList.add('show'), 50);
        setTimeout(() => hintL.classList.remove('show'), 1200);
      }
      if (curPage < sesEnd) {
        const hintR = document.createElement('div');
        hintR.className = 'tap-hint right';
        hintR.textContent = S.lang === 'ar' ? 'â–¶' : 'â–¶';
        wrap.appendChild(hintR);
        setTimeout(() => hintR.classList.add('show'), 50);
        setTimeout(() => hintR.classList.remove('show'), 1200);
      }
      wrap.appendChild(img);
      body.appendChild(wrap);
      const info = document.createElement('div');
      info.style.cssText = 'font-size:11px;color:var(--text-muted);text-align:center;padding:6px';
      info.textContent = `${S.lang === 'ar' ? 'ØµÙØ­Ø©' : 'Page'} ${numStr(pg)} / ${numStr(QURAN_PAGES)}`;
      body.appendChild(info);
    };
    img.onerror = () => {
      if (src !== `https://raw.githubusercontent.com/QuranHub/quran-pages-images/main/ayat/hafs/${pg}.png`) {
        showImg(`https://raw.githubusercontent.com/QuranHub/quran-pages-images/main/ayat/hafs/${pg}.png`);
      } else {
        body.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-muted)">
          <div style="font-size:36px;margin-bottom:10px">ğŸ“„</div>
          <div>${S.lang === 'ar' ? 'ØµÙØ­Ø©' : 'Page'} ${numStr(pg)}</div>
          <div style="font-size:11px;margin-top:8px">${S.lang === 'ar' ? 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„' : 'Load failed. Check connection'}</div>
        </div>`;
      }
    };
    img.src = src;
  }

  showImg(url);

  document.getElementById('qmPrev').disabled = curPage <= sesStart;
  document.getElementById('qmNext').disabled = curPage >= sesEnd;
}

document.getElementById('qmPrev').onclick = () => { if(curPage>sesStart){ curPage--; loadQPage(curPage); } };
document.getElementById('qmNext').onclick = () => { if(curPage<sesEnd){ curPage++; loadQPage(curPage); } };
document.getElementById('qmClose').onclick = () => document.getElementById('qmodal').classList.remove('show');

// â”€â”€ Swipe + Tap-zone navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const body = document.getElementById('qmBody');
  let touchStartX = 0, touchStartY = 0, touchStartTime = 0;
  const MIN_SWIPE = 50;   // px minimum horizontal distance
  const MAX_VERT  = 80;   // px max vertical drift allowed
  const MAX_TAP   = 220;  // ms max duration for a tap

  function goNext() { if (curPage < sesEnd)  { curPage++; loadQPage(curPage); } }
  function goPrev() { if (curPage > sesStart){ curPage--; loadQPage(curPage); } }

  // â”€â”€ Touch events (mobile) â”€â”€
  body.addEventListener('touchstart', e => {
    touchStartX    = e.touches[0].clientX;
    touchStartY    = e.touches[0].clientY;
    touchStartTime = Date.now();
  }, { passive: true });

  body.addEventListener('touchend', e => {
    const dx       = e.changedTouches[0].clientX - touchStartX;
    const dy       = e.changedTouches[0].clientY - touchStartY;
    const dt       = Date.now() - touchStartTime;
    const absDx    = Math.abs(dx);
    const absDy    = Math.abs(dy);

    // â”€â”€ Tap detection (short + small movement) â”€â”€
    if (dt < MAX_TAP && absDx < 20 && absDy < 20) {
      const rect  = body.getBoundingClientRect();
      const tapX  = e.changedTouches[0].clientX - rect.left;
      const third = rect.width / 3;
      // Left third â†’ previous, Right third â†’ next, Middle â†’ nothing
      if (tapX < third)        goPrev();
      else if (tapX > third*2) goNext();
      return;
    }

    // â”€â”€ Swipe detection â”€â”€
    if (absDx < MIN_SWIPE || absDy > MAX_VERT) return; // not a clean swipe
    // Arabic RTL logic:
    //   swipe RIGHT (dx > 0) â†’ go to NEXT page (like turning page forward in Arabic book)
    //   swipe LEFT  (dx < 0) â†’ go to PREV page
    if (dx > 0) goNext();
    else        goPrev();
  }, { passive: true });

  // â”€â”€ Mouse click zones (desktop/PWA) â”€â”€
  body.addEventListener('click', e => {
    // Ignore clicks on the image wrapper itself (let touch handle it)
    // Only handle clicks directly on qmBody background
    if (e.target === body || e.target.classList.contains('qm-img-wrap') || e.target.classList.contains('qm-img')) {
      const rect  = body.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const third  = rect.width / 3;
      if (clickX < third)       goPrev();
      else if (clickX > third*2) goNext();
    }
  });
})();

function markDone() {
  if (!curSession) return;
  S.completedSessions[curSession] = true;
  savePersist();
  document.getElementById('qmodal').classList.remove('show');
  updateQuranUI();
  showToast(t('khatmDone'));
}

function confirmResetQuran() {
  if (confirm(t('confirmReset'))) {
    S.completedSessions = {};
    savePersist();
    updateQuranUI();
    showToast(t('toastReset'));
  }
}

// =============================================================
// TABS / NAV
// =============================================================
function switchTab(tab) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`panel-${tab}`).classList.add('active');
  document.getElementById(`nav-${tab}`).classList.add('active');
  closeSideEffects();
  trackTab(tab);
}
function closeSideEffects() {}
function goNotif() { switchTab('notif'); askNotifPermission(); }

// =============================================================
// LOADING
// =============================================================
function hideLoading() {
  const el = document.getElementById('loadingScreen');
  el.classList.add('gone');
  setTimeout(() => el.style.display='none', 600);
}

// =============================================================
// PWA INSTALL
// =============================================================
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); deferredPrompt = e;
  if (!isStandalone()) {
    const bar = document.getElementById('installBar');
    bar.classList.add('show');
  }
});
document.getElementById('ib-install-btn').onclick = async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') showToast('âœ… '+(S.lang==='ar'?'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª':'Installed!'));
    deferredPrompt = null;
    document.getElementById('installBar').classList.remove('show');
  }
};

// =============================================================
// SERVICE WORKER
// =============================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(e => console.warn('SW:', e));
}

// =============================================================
// FIND NEAREST CITY (for auto method detection)
// =============================================================
function findNearestCity(lat, lng) {
  let nearest = null, minDist = Infinity;
  CITIES.forEach(c => {
    const d = Math.sqrt(Math.pow(c.lat - lat, 2) + Math.pow(c.lng - lng, 2));
    if (d < minDist) { minDist = d; nearest = c; }
  });
  return nearest; // returns city obj or null
}

// =============================================================
// AZAN AUDIO SYSTEM
// =============================================================
const AZAN_URL = 'https://raw.githubusercontent.com/bassamaljazzar93/ramadan-app/main/azan.mp3';
let azanAudio = null;
let azanTimer = null;

function playAzan(prayerName, prayerTime) {
  // Stop any existing
  stopAzan(false);

  azanAudio = new Audio(AZAN_URL);
  azanAudio.volume = 1.0;
  azanAudio.loop = false;
  azanAudio.play().catch(err => {
    console.warn('Azan play failed (user gesture required):', err);
    // Show banner anyway - user can interact
  });

  azanAudio.onended = () => hideAzanBanner();
  azanAudio.onerror = () => hideAzanBanner();

  // Update banner text
  const titleEl = document.getElementById('azanTitle');
  const subEl   = document.getElementById('azanSub');
  const stopBtn = document.getElementById('azanStopBtn');

  if (titleEl) titleEl.textContent = `ğŸ•Œ ${prayerName || (S.lang==='ar'?'Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©':'Prayer Time')}`;
  if (subEl)   subEl.textContent   = prayerTime ? `${S.lang==='ar'?'Ø§Ù„Ø£Ø°Ø§Ù†':'Azan'} - ${prayerTime}` : (S.lang==='ar'?'Ø§Ù„Ø£Ø°Ø§Ù† ÙŠÙØ´ØºÙÙ‘Ù„ Ø§Ù„Ø¢Ù†':'Azan is playing');
  if (stopBtn) stopBtn.textContent = S.lang==='ar' ? 'â¹ Ø¥ÙŠÙ‚Ø§Ù' : 'â¹ Stop';

  // Show banner
  showAzanBanner();

  // Auto-hide after 5 minutes
  azanTimer = setTimeout(() => stopAzan(), 5 * 60 * 1000);
}

function stopAzan(hideBanner = true) {
  if (azanAudio) {
    azanAudio.pause();
    azanAudio.currentTime = 0;
    azanAudio = null;
  }
  if (azanTimer) { clearTimeout(azanTimer); azanTimer = null; }
  if (hideBanner) hideAzanBanner();
}

function showAzanBanner() {
  const banner = document.getElementById('azanBanner');
  if (banner) {
    banner.classList.add('show');
    // Push app content down
    document.getElementById('app').style.paddingTop = '88px';
  }
}

function hideAzanBanner() {
  const banner = document.getElementById('azanBanner');
  if (banner) {
    banner.classList.remove('show');
    document.getElementById('app').style.paddingTop = '0';
  }
}

// Listen for SW messages to play azan
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', e => {
    if (e.data?.type === 'PLAY_AZAN') {
      playAzan(e.data.prayerName, e.data.prayerTime);
    }
  });
}

// =============================================================
// INIT
// =============================================================
document.addEventListener('DOMContentLoaded', () => {
  createStars();
  loadPersist();
  applyLang();
  updateLocationDisplay();

  // Update loading text
  setText('loadingTxt', t('loading'));
  setText('loadingNote', t('loadingNote'));

  // Restore khatm tabs
  document.querySelectorAll('.ks-tab').forEach((el,i) => el.classList.toggle('active', i===S.khatmat-1));

  // Restore notif toggle states
  ['suhoor','qiyam','iftar','dhikr'].forEach(id => {
    const tog = document.getElementById(`tog-${id}`);
    if (tog) {
      tog.checked = !!S.notifSettings[id];
      const tp = document.getElementById(`tp-${id}`);
      if (tp) tp.classList.toggle('show', !!S.notifSettings[id]);
      const ti = document.getElementById(`time-${id}`);
      if (ti && S.notifSettings[`${id}Time`]) ti.value = S.notifSettings[`${id}Time`];
    }
  });

  // Method select
  if (S.method) document.getElementById('methodSelect').value = S.method;

  // Start countdown ticker
  setInterval(() => { if (S.prayers.Maghrib) updateCountdown(); }, 1000);

  // Layer 3: minute fallback â€” catch any alarm missed within 90s window
  setInterval(checkMissedAlarms, 60000);

  // Re-schedule whenever app returns to foreground
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') scheduleNotifications();
  });
  window.addEventListener('focus', scheduleNotifications);

  // Render city list ready
  renderCityList();

  // Show onboarding or load data
  if (!S.initialized) {
    // iOS/Android: hide loading immediately, show onboarding right away
    // Don't fetch ANYTHING until user presses "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†" or "ØªØ®Ø·Ù‰"
    hideLoading();
    showOnboarding();
    // Silently get GPS in background just to update the âœ… indicator
    // but do NOT call fetchPrayerTimes or show loading screen
    if (navigator.geolocation) {
      setTimeout(() => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            S.lat = pos.coords.latitude;
            S.lng = pos.coords.longitude;
            document.getElementById('locStatus').textContent = 'âœ…';
            // Find nearest city method
            const nearest = findNearestCity(S.lat, S.lng);
            if (nearest) S.method = nearest.method;
            // Reverse geocode quietly
            reverseGeocode();
          },
          () => { document.getElementById('locStatus').textContent = 'âŒ'; },
          { timeout: 8000, maximumAge: 300000 }
        );
      }, 300);
    }
  } else {
    // Already initialized - load saved data immediately
    if (S.lat) {
      fetchPrayerTimes();
    } else {
      hideLoading();
      openCitySelector();
    }

    // Silently refresh GPS in background - update if moved > ~1km
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const newLat = pos.coords.latitude;
          const newLng = pos.coords.longitude;
          const latDiff = Math.abs(newLat - (S.lat || 0));
          const lngDiff = Math.abs(newLng - (S.lng || 0));
          if (latDiff > 0.009 || lngDiff > 0.009) {
            S.lat = newLat; S.lng = newLng;
            const nearest = findNearestCity(newLat, newLng);
            if (nearest) S.method = nearest.method;
            reverseGeocode().then(() => {
              savePersist();
              fetchPrayerTimes();
              showToast('ğŸ“ ' + (S.lang==='ar' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Øª' : 'Location & times updated'));
            });
          }
        },
        () => {},
        { timeout: 10000, maximumAge: 60000 }
      );
    }

// ============================================================
//  GREENAPI CONFIG
// ============================================================
const GA_CFG = {
  instanceId: '7105449423',
  apiToken:   'a0117c3d90c0408681b858f6ea4625634e8fad633b774dbea2',
  baseUrl:    'https://7105.api.greenapi.com',
  devPhone:   '971566113381'
};

async function sendToWhatsApp(phone, text) {
  const url = `${GA_CFG.baseUrl}/waInstance${GA_CFG.instanceId}/sendMessage/${GA_CFG.apiToken}`;
  try {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chatId: `${phone}@c.us`, message: text })
    });
    return r.ok;
  } catch { return false; }
}

// ============================================================
//  ANALYTICS â€” LOCAL TRACKING
// ============================================================
function getAnalytics() {
  return JSON.parse(localStorage.getItem('ramadan_analytics') || '{}');
}
function saveAnalytics(d) {
  localStorage.setItem('ramadan_analytics', JSON.stringify(d));
}

function trackVisit() {
  const today = new Date().toISOString().slice(0, 10);
  const d = getAnalytics();
  if (!d.days) d.days = {};
  if (!d.days[today]) d.days[today] = { visits: 0, tabs: {}, cities: {}, langs: {} };
  d.days[today].visits++;
  if (!d.totalVisits) d.totalVisits = 0;
  d.totalVisits++;
  saveAnalytics(d);
}

function trackTab(tab) {
  const today = new Date().toISOString().slice(0, 10);
  const d = getAnalytics();
  if (!d.days) d.days = {};
  if (!d.days[today]) d.days[today] = { visits: 0, tabs: {}, cities: {}, langs: {} };
  d.days[today].tabs[tab] = (d.days[today].tabs[tab] || 0) + 1;
  saveAnalytics(d);
}

function trackCity(city) {
  const today = new Date().toISOString().slice(0, 10);
  const d = getAnalytics();
  if (!d.days) d.days = {};
  if (!d.days[today]) d.days[today] = { visits: 0, tabs: {}, cities: {}, langs: {} };
  d.days[today].cities[city] = (d.days[today].cities[city] || 0) + 1;
  saveAnalytics(d);
}

function trackLang(lang) {
  const today = new Date().toISOString().slice(0, 10);
  const d = getAnalytics();
  if (!d.days) d.days = {};
  if (!d.days[today]) d.days[today] = { visits: 0, tabs: {}, cities: {}, langs: {} };
  d.days[today].langs[lang] = (d.days[today].langs[lang] || 0) + 1;
  saveAnalytics(d);
}

// ============================================================
//  DAILY REPORT â€” ÙŠÙØ±Ø³ÙÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ============================================================
async function maybeSendDailyReport() {
  const today = new Date().toISOString().slice(0, 10);
  const lastReport = localStorage.getItem('ramadan_last_report');
  if (lastReport === today) return; // Ø³Ø¨Ù‚ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ…

  const d = getAnalytics();
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  const day = d.days?.[yesterday];

  if (!day) return; // Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø£Ù…Ø³

  const topTabs = Object.entries(day.tabs || {})
    .sort((a,b) => b[1]-a[1]).slice(0,3)
    .map(([k,v]) => `${k}: ${v}`).join(' | ') || 'â€”';

  const topCities = Object.entries(day.cities || {})
    .sort((a,b) => b[1]-a[1]).slice(0,3)
    .map(([k,v]) => `${k}: ${v}`).join(' | ') || 'â€”';

  const langs = Object.entries(day.langs || {})
    .map(([k,v]) => `${k}: ${v}`).join(' | ') || 'â€”';

  const report = `ğŸ“Š *ØªÙ‚Ø±ÙŠØ± Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ… PWA â€” ${yesterday}*

ğŸ‘ï¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${day.visits || 0}
ğŸ“± Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ: ${d.totalVisits || 0}

ğŸ—‚ï¸ Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹:
${topTabs}

ğŸ“ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø¯Ù†:
${topCities}

ğŸŒ Ø§Ù„Ù„ØºØ§Øª:
${langs}

â€”
ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙˆÙ…ÙŠ ğŸ¤–`;

  const ok = await sendToWhatsApp(GA_CFG.devPhone, report);
  if (ok) localStorage.setItem('ramadan_last_report', today);
}

// ============================================================
//  CONTACT MODAL
// ============================================================
function openContactModal() {
  document.getElementById('contactModalOverlay').classList.add('active');
}
function closeContactModal() {
  document.getElementById('contactModalOverlay').classList.remove('active');
}
function closeContactIfOutside(e) {
  if (e.target.id === 'contactModalOverlay') closeContactModal();
}

async function sendContactMessage() {
  const name = document.getElementById('cm-name').value.trim();
  const msg  = document.getElementById('cm-message').value.trim();
  const status = document.getElementById('cm-status');
  const btn  = document.getElementById('cm-send-btn');

  if (!msg) {
    status.textContent = 'âš ï¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©';
    status.className = 'contact-status err';
    status.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.textContent = '...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';

  const city = localStorage.getItem('ramadan_city') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const lang = localStorage.getItem('ramadan_lang') || 'ar';

  const text = `ğŸ’¬ *Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù… â€” Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ… PWA*

ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name || 'Ù„Ù… ÙŠØ°ÙƒØ±'}
ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${city}
ğŸŒ Ø§Ù„Ù„ØºØ©: ${lang}

ğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:
${msg}`;

  const ok = await sendToWhatsApp(GA_CFG.devPhone, text);

  btn.disabled = false;
  btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ âœ‰ï¸';

  if (ok) {
    status.textContent = 'âœ… ÙˆØµÙ„Øª Ø±Ø³Ø§Ù„ØªÙƒ! Ø´ÙƒØ±Ø§Ù‹';
    status.className = 'contact-status ok';
    document.getElementById('cm-name').value = '';
    document.getElementById('cm-message').value = '';
    setTimeout(closeContactModal, 2500);
  } else {
    status.textContent = 'âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹';
    status.className = 'contact-status err';
  }
  status.style.display = 'block';
}

// ============================================================
//  INIT ANALYTICS ON LOAD
// ============================================================
trackVisit();
maybeSendDailyReport();


<!-- ===== CONTACT MODAL ===== -->
<div class="contact-modal-overlay" id="contactModalOverlay" onclick="closeContactIfOutside(event)">
  <div class="contact-modal" id="contactModal">
    <button class="contact-close-btn" onclick="closeContactModal()">âœ•</button>
    <h3>ğŸ’¬ <span id="cm-title">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±</span></h3>
    <p id="cm-desc">Ø±Ø³Ø§Ù„ØªÙƒ Ø³ØªØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ â€” Ø±Ø¯ÙˆØ¯ÙŠ Ø³Ø±ÙŠØ¹Ø© Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡</p>
    <div class="cg">
      <label id="cm-lbl-name">Ø§Ù„Ø§Ø³Ù…</label>
      <input type="text" id="cm-name" placeholder="Ø§Ø³Ù…Ùƒ">
    </div>
    <div class="cg">
      <label id="cm-lbl-msg">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
      <textarea id="cm-message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
    </div>
    <button class="contact-send-btn" id="cm-send-btn" onclick="sendContactMessage()">
      Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ âœ‰ï¸
    </button>
    <div class="contact-status" id="cm-status"></div>
  </div>
</div>
